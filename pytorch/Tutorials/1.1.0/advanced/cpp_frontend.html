
<!DOCTYPE html>

<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Using the PyTorch C++ Frontend — PyTorch Tutorials 1.1.0 documentation</title>
<link href="../_static/css/theme.css" rel="stylesheet" type="text/css"/>
<!-- <link rel="stylesheet" href="../_static/pygments.css" type="text/css" /> -->
<link href="../_static/gallery.css" rel="stylesheet" type="text/css"/>
<link href="../genindex.html" rel="index" title="Index"/>
<link href="../search.html" rel="search" title="Search"/>
<link href="cpp_export.html" rel="prev" title="Loading a PyTorch Model in C++"/>
<script src="../_static/js/modernizr.min.js"></script>
</head>
<div class="container-fluid header-holder tutorials-header" id="header-holder">
<div class="container">
<div class="header-container">
<a aria-label="PyTorch" class="header-logo" href="https://pytorch.org/"></a>
<div class="main-menu">
<ul>
<li>
<a href="https://pytorch.org/get-started">Get Started</a>
</li>
<li>
<a href="https://pytorch.org/features">Features</a>
</li>
<li>
<a href="https://pytorch.org/ecosystem">Ecosystem</a>
</li>
<li>
<a href="https://pytorch.org/blog/">Blog</a>
</li>
<li class="active">
<a href="https://pytorch.org/tutorials">Tutorials</a>
</li>
<li>
<a href="https://pytorch.org/docs/stable/index.html">Docs</a>
</li>
<li>
<a href="https://pytorch.org/resources">Resources</a>
</li>
<li>
<a href="https://github.com/pytorch/pytorch">Github</a>
</li>
</ul>
</div>
<a class="main-menu-open-button" data-behavior="open-mobile-menu" href="#"></a>
</div>
</div>
</div>
<body class="pytorch-body">
<div class="table-of-contents-link-wrapper">
<span>Table of Contents</span>
<a class="toggle-table-of-contents" data-behavior="toggle-table-of-contents" href="#"></a>
</div>
<nav class="pytorch-left-menu" data-toggle="wy-nav-shift" id="pytorch-left-menu">
<div class="pytorch-side-scroll">
<div aria-label="main navigation" class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation">
<div class="pytorch-left-menu-search">
<div class="version">
                  1.1.0
                </div>
<div role="search">
<form action="../search.html" class="wy-form" id="rtd-search-form" method="get">
<input name="q" placeholder="Search Tutorials" type="text"/>
<input name="check_keywords" type="hidden" value="yes"/>
<input name="area" type="hidden" value="default"/>
</form>
</div>
</div>
<p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../beginner/deep_learning_60min_blitz.html">Deep Learning with PyTorch: A 60 Minute Blitz</a></li>
<li class="toctree-l1"><a class="reference internal" href="../beginner/data_loading_tutorial.html">Data Loading and Processing Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../beginner/pytorch_with_examples.html">Learning PyTorch with Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../beginner/transfer_learning_tutorial.html">Transfer Learning Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../beginner/deploy_seq2seq_hybrid_frontend_tutorial.html">Deploying a Seq2Seq Model with the Hybrid Frontend</a></li>
<li class="toctree-l1"><a class="reference internal" href="../beginner/saving_loading_models.html">Saving and Loading Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../beginner/nn_tutorial.html">What is <cite>torch.nn</cite> <em>really</em>?</a></li>
</ul>
<p class="caption"><span class="caption-text">Image</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../intermediate/torchvision_tutorial.html">TorchVision 0.3 Object Detection Finetuning Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../beginner/finetuning_torchvision_models_tutorial.html">Finetuning Torchvision Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intermediate/spatial_transformer_tutorial.html">Spatial Transformer Networks Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="neural_style_tutorial.html">Neural Transfer Using PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../beginner/fgsm_tutorial.html">Adversarial Example Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="super_resolution_with_caffe2.html">Transfering a Model from PyTorch to Caffe2 and Mobile using ONNX</a></li>
</ul>
<p class="caption"><span class="caption-text">Text</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../beginner/chatbot_tutorial.html">Chatbot Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intermediate/char_rnn_generation_tutorial.html">Generating Names with a Character-Level RNN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intermediate/char_rnn_classification_tutorial.html">Classifying Names with a Character-Level RNN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../beginner/deep_learning_nlp_tutorial.html">Deep Learning for NLP with Pytorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intermediate/seq2seq_translation_tutorial.html">Translation with a Sequence to Sequence Network and Attention</a></li>
</ul>
<p class="caption"><span class="caption-text">Generative</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../beginner/dcgan_faces_tutorial.html">DCGAN Tutorial</a></li>
</ul>
<p class="caption"><span class="caption-text">Reinforcement Learning</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../intermediate/reinforcement_q_learning.html">Reinforcement Learning (DQN) Tutorial</a></li>
</ul>
<p class="caption"><span class="caption-text">Extending PyTorch</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="numpy_extensions_tutorial.html">Creating Extensions Using numpy and scipy</a></li>
<li class="toctree-l1"><a class="reference internal" href="cpp_extension.html">Custom C++ and CUDA Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="torch_script_custom_ops.html">Extending TorchScript with Custom C++ Operators</a></li>
</ul>
<p class="caption"><span class="caption-text">Production Usage</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../intermediate/model_parallel_tutorial.html">Model Parallel Best Practices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intermediate/ddp_tutorial.html">Getting Started with Distributed Data Parallel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intermediate/dist_tuto.html">Writing Distributed Applications with PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../beginner/aws_distributed_training_tutorial.html">PyTorch 1.0 Distributed Trainer with Amazon AWS</a></li>
<li class="toctree-l1"><a class="reference internal" href="ONNXLive.html">ONNX Live Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="cpp_export.html">Loading a PyTorch Model in C++</a></li>
</ul>
<p class="caption"><span class="caption-text">PyTorch in Other Languages</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Using the PyTorch C++ Frontend</a></li>
</ul>
</div>
</div>
</nav>
<div class="pytorch-container">
<div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
<div class="pytorch-breadcrumbs-wrapper">
<div aria-label="breadcrumbs navigation" role="navigation">
<ul class="pytorch-breadcrumbs">
<li>
<a href="../index.html">
          
            Tutorials
          
        </a> &gt;
      </li>
<li>Using the PyTorch C++ Frontend</li>
<li class="pytorch-breadcrumbs-aside">
<a href="../_sources/advanced/cpp_frontend.rst.txt" rel="nofollow"><img src="../_static/images/view-page-source-icon.svg"/></a>
</li>
</ul>
</div>
</div>
<div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
</div>
<section class="pytorch-content-wrap" data-toggle="wy-nav-shift" id="pytorch-content-wrap">
<div class="pytorch-content-left">
<div class="rst-content">
<div class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article" role="main">
<article class="pytorch-article" id="pytorch-article" itemprop="articleBody">
<div class="section" id="using-the-pytorch-c-frontend">
<h1>Using the PyTorch C++ Frontend<a class="headerlink" href="#using-the-pytorch-c-frontend" title="Permalink to this headline">¶</a></h1>
<p>The PyTorch C++ frontend is a pure C++ interface to the PyTorch machine learning
framework. While the primary interface to PyTorch naturally is Python, this
Python API sits atop a substantial C++ codebase providing foundational data
structures and functionality such as tensors and automatic differentiation. The
C++ frontend exposes a pure C++11 API that extends this underlying C++ codebase
with tools required for machine learning training and inference. This includes a
built-in collection of common components for neural network modeling; an API to
extend this collection with custom modules; a library of popular optimization
algorithms such as stochastic gradient descent; a parallel data loader with an
API to define and load datasets; serialization routines and more.</p>
<p>This tutorial will walk you through an end-to-end example of training a model
with the C++ frontend. Concretely, we will be training a <a class="reference external" href="https://arxiv.org/abs/1511.06434">DCGAN</a> – a kind of generative model – to
generate images of MNIST digits. While conceptually a simple example, it should
be enough to give you a whirlwind overview of the PyTorch C++ frontend and wet
your appetite for training more complex models. We will begin with some
motivating words for why you would want to use the C++ frontend to begin with,
and then dive straight into defining and training our model.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Watch <a class="reference external" href="https://www.youtube.com/watch?v=auRPXMMHJzc">this lightning talk from CppCon 2018</a> for a quick (and humorous)
presentation on the C++ frontend.</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last"><a class="reference external" href="https://pytorch.org/cppdocs/frontend.html">This note</a> provides a sweeping
overview of the C++ frontend’s components and design philosophy.</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Documentation for the PyTorch C++ ecosystem is available at
<a class="reference external" href="https://pytorch.org/cppdocs">https://pytorch.org/cppdocs</a>. There you can find high level descriptions as
well as API-level documentation.</p>
</div>
<div class="section" id="motivation">
<h2>Motivation<a class="headerlink" href="#motivation" title="Permalink to this headline">¶</a></h2>
<p>Before we embark on our exciting journey of GANs and MNIST digits, let’s take a
step back and discuss why you would want to use the C++ frontend instead of the
Python one to begin with. We (the PyTorch team) created the C++ frontend to
enable research in environments in which Python cannot be used, or is simply not
the right tool for the job. Examples for such environments include:</p>
<ul class="simple">
<li><strong>Low Latency Systems</strong>: You may want to do reinforcement learning research in
a pure C++ game engine with high frames-per-second and low latency
requirements. Using a pure C++ library is a much better fit to such an
environment than a Python library. Python may not be tractable at all because
of the slowness of the Python interpreter.</li>
<li><strong>Highly Multithreaded Environments</strong>: Due to the Global Interpreter Lock
(GIL), Python cannot run more than one system thread at a time.
Multiprocessing is an alternative, but not as scalable and has significant
shortcomings. C++ has no such constraints and threads are easy to use and
create. Models requiring heavy parallelization, like those used in <a class="reference external" href="https://eng.uber.com/deep-neuroevolution/">Deep
Neuroevolution</a>, can benefit from
this.</li>
<li><strong>Existing C++ Codebases</strong>: You may be the owner of an existing C++
application doing anything from serving web pages in a backend server to
rendering 3D graphics in photo editing software, and wish to integrate
machine learning methods into your system. The C++ frontend allows you to
remain in C++ and spare yourself the hassle of binding back and forth between
Python and C++, while retaining much of the flexibility and intuitiveness of
the traditional PyTorch (Python) experience.</li>
</ul>
<p>The C++ frontend is not intended to compete with the Python frontend. It is
meant to complement it. We know researchers and engineers alike love PyTorch for
its simplicity, flexibility and intuitive API. Our goal is to make sure you can
take advantage of these core design principles in every possible environment,
including the ones described above. If one of these scenarios describes your use
case well, or if you are simply interested or curious, follow along as we
explore the C++ frontend in detail in the following paragraphs.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">The C++ frontend tries to provide an API as close as possible to that of the
Python frontend. If you are experienced with the Python frontend and ever ask
yourself “how do I do X with the C++ frontend?”, write your code the way you
would in Python, and more often than not the same functions and methods will
be available in C++ as in Python (just remember to replace dots with double
colons).</p>
</div>
</div>
<div class="section" id="writing-a-basic-application">
<h2>Writing a Basic Application<a class="headerlink" href="#writing-a-basic-application" title="Permalink to this headline">¶</a></h2>
<p>Let’s begin by writing a minimal C++ application to verify that we’re on the
same page regarding our setup and build environment. First, you will need to
grab a copy of the <em>LibTorch</em> distribution – our ready-built zip archive that
packages all relevant headers, libraries and CMake build files required to use
the C++ frontend. The LibTorch distribution is available for download on the
<a class="reference external" href="https://pytorch.org/get-started/locally/">PyTorch website</a> for Linux, MacOS
and Windows. The rest of this tutorial will assume a basic Ubuntu Linux
environment, however you are free to follow along on MacOS or Windows too.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">The note on <a class="reference external" href="https://pytorch.org/cppdocs/installing.html">Installing C++ Distributions of PyTorch</a> describes the following steps
in more detail.</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">On Windows, debug and release builds are not ABI-compatible. If you plan to
build your project in debug mode, please try the debug version of LibTorch.</p>
</div>
<p>The first step is to download the LibTorch distribution locally, via the link
retrieved from the PyTorch website. For a vanilla Ubuntu Linux environment, this
means running:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># If you need e.g. CUDA 9.0 support, please replace "cpu" with "cu90" in the URL below.</span>
wget https://download.pytorch.org/libtorch/nightly/cpu/libtorch-shared-with-deps-latest.zip
unzip libtorch-shared-with-deps-latest.zip
</pre></div>
</div>
<p>Next, let’s write a tiny C++ file called <code class="docutils literal notranslate"><span class="pre">dcgan.cpp</span></code> that includes
<code class="docutils literal notranslate"><span class="pre">torch/torch.h</span></code> and for now simply prints out a three by three identity
matrix:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;torch/torch.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">torch</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">::</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">tensor</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>To build this tiny application as well as our full-fledged training script later
on we’ll use this <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> file:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span> <span class="s">3.0</span> <span class="s">FATAL_ERROR</span><span class="p">)</span>
<span class="nb">project</span><span class="p">(</span><span class="s">dcgan</span><span class="p">)</span>

<span class="nb">find_package</span><span class="p">(</span><span class="s">Torch</span> <span class="s">REQUIRED</span><span class="p">)</span>

<span class="nb">add_executable</span><span class="p">(</span><span class="s">dcgan</span> <span class="s">dcgan.cpp</span><span class="p">)</span>
<span class="nb">target_link_libraries</span><span class="p">(</span><span class="s">dcgan</span> <span class="s2">"${TORCH_LIBRARIES}"</span><span class="p">)</span>
<span class="nb">set_property</span><span class="p">(</span><span class="s">TARGET</span> <span class="s">dcgan</span> <span class="s">PROPERTY</span> <span class="s">CXX_STANDARD</span> <span class="s">11</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">While CMake is the recommended build system for LibTorch, it is not a hard
requirement. You can also use Visual Studio project files, QMake, plain
Makefiles or any other build environment you feel comfortable with. However,
we do not provide out-of-the-box support for this.</p>
</div>
<p>Make note of line 4 in the above CMake file: <code class="docutils literal notranslate"><span class="pre">find_package(Torch</span> <span class="pre">REQUIRED)</span></code>.
This instructs CMake to find the build configuration for the LibTorch library.
In order for CMake to know <em>where</em> to find these files, we must set the
<code class="docutils literal notranslate"><span class="pre">CMAKE_PREFIX_PATH</span></code> when invoking <code class="docutils literal notranslate"><span class="pre">cmake</span></code>. Before we do this, let’s agree on
the following directory structure for our <code class="docutils literal notranslate"><span class="pre">dcgan</span></code> application:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>dcgan/
  CMakeLists.txt
  dcgan.cpp
</pre></div>
</div>
<p>Further, I will refer to the path to the unzipped LibTorch distribution as
<code class="docutils literal notranslate"><span class="pre">/path/to/libtorch</span></code>. Note that this <strong>must be an absolute path</strong>. In
particular, setting <code class="docutils literal notranslate"><span class="pre">CMAKE_PREFIX_PATH</span></code> to something like <code class="docutils literal notranslate"><span class="pre">../../libtorch</span></code>
will break in unexpected ways. Instead, write <code class="docutils literal notranslate"><span class="pre">$PWD/../../libtorch</span></code> to get the
corresponding absolute path. Now, we are ready to build our application:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>root@fa350df05ecf:/home# mkdir build
root@fa350df05ecf:/home# <span class="nb">cd</span> build
root@fa350df05ecf:/home/build# cmake -DCMAKE_PREFIX_PATH<span class="o">=</span>/path/to/libtorch ..
-- The C compiler identification is GNU <span class="m">5</span>.4.0
-- The CXX compiler identification is GNU <span class="m">5</span>.4.0
-- Check <span class="k">for</span> working C compiler: /usr/bin/cc
-- Check <span class="k">for</span> working C compiler: /usr/bin/cc -- works
-- Detecting C compiler ABI info
-- Detecting C compiler ABI info - <span class="k">done</span>
-- Detecting C compile features
-- Detecting C compile features - <span class="k">done</span>
-- Check <span class="k">for</span> working CXX compiler: /usr/bin/c++
-- Check <span class="k">for</span> working CXX compiler: /usr/bin/c++ -- works
-- Detecting CXX compiler ABI info
-- Detecting CXX compiler ABI info - <span class="k">done</span>
-- Detecting CXX compile features
-- Detecting CXX compile features - <span class="k">done</span>
-- Looking <span class="k">for</span> pthread.h
-- Looking <span class="k">for</span> pthread.h - found
-- Looking <span class="k">for</span> pthread_create
-- Looking <span class="k">for</span> pthread_create - not found
-- Looking <span class="k">for</span> pthread_create in pthreads
-- Looking <span class="k">for</span> pthread_create in pthreads - not found
-- Looking <span class="k">for</span> pthread_create in pthread
-- Looking <span class="k">for</span> pthread_create in pthread - found
-- Found Threads: TRUE
-- Found torch: /path/to/libtorch/lib/libtorch.so
-- Configuring <span class="k">done</span>
-- Generating <span class="k">done</span>
-- Build files have been written to: /home/build
root@fa350df05ecf:/home/build# make -j
Scanning dependencies of target dcgan
<span class="o">[</span> <span class="m">50</span>%<span class="o">]</span> Building CXX object CMakeFiles/dcgan.dir/dcgan.cpp.o
<span class="o">[</span><span class="m">100</span>%<span class="o">]</span> Linking CXX executable dcgan
<span class="o">[</span><span class="m">100</span>%<span class="o">]</span> Built target dcgan
</pre></div>
</div>
<p>Above, we first created a <code class="docutils literal notranslate"><span class="pre">build</span></code> folder inside of our <code class="docutils literal notranslate"><span class="pre">dcgan</span></code> directory,
entered this folder, ran the <code class="docutils literal notranslate"><span class="pre">cmake</span></code> command to generate the necessary build
(Make) files and finally compiled the project successfully by running <code class="docutils literal notranslate"><span class="pre">make</span>
<span class="pre">-j</span></code>. We are now all set to execute our minimal binary and complete this section
on basic project configuration:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>root@fa350df05ecf:/home/build# ./dcgan
<span class="m">1</span>  <span class="m">0</span>  <span class="m">0</span>
<span class="m">0</span>  <span class="m">1</span>  <span class="m">0</span>
<span class="m">0</span>  <span class="m">0</span>  <span class="m">1</span>
<span class="o">[</span> Variable<span class="o">[</span>CPUFloatType<span class="o">]{</span><span class="m">3</span>,3<span class="o">}</span> <span class="o">]</span>
</pre></div>
</div>
<p>Looks like an identity matrix to me!</p>
</div>
<div class="section" id="defining-the-neural-network-models">
<h2>Defining the Neural Network Models<a class="headerlink" href="#defining-the-neural-network-models" title="Permalink to this headline">¶</a></h2>
<p>Now that we have our basic environment configured, we can dive into the much
more interesting parts of this tutorial. First, we will discuss how to define
and interact with modules in the C++ frontend. We’ll begin with basic,
small-scale example modules and then implement a full-fledged GAN using the
extensive library of built-in modules provided by the C++ frontend.</p>
<div class="section" id="module-api-basics">
<h3>Module API Basics<a class="headerlink" href="#module-api-basics" title="Permalink to this headline">¶</a></h3>
<p>In line with the Python interface, neural networks based on the C++ frontend are
composed of reusable building blocks called <em>modules</em>. There is a base module
class from which all other modules are derived. In Python, this class is
<code class="docutils literal notranslate"><span class="pre">torch.nn.Module</span></code> and in C++ it is <code class="docutils literal notranslate"><span class="pre">torch::nn::Module</span></code>. Besides a
<code class="docutils literal notranslate"><span class="pre">forward()</span></code> method that implements the algorithm the module encapsulates, a
module usually contains any of three kinds of sub-objects: parameters, buffers
and submodules.</p>
<p>Parameters and buffers store state in form of tensors. Parameters record
gradients, while buffers do not. Parameters are usually the trainable weights of
your neural network. Examples of buffers include means and variances for batch
normalization. In order to re-use particular blocks of logic and state, the
PyTorch API allows modules to be nested. A nested module is termed a
<em>submodule</em>.</p>
<p>Parameters, buffers and submodules must be explicitly registered. Once
registered, methods like <code class="docutils literal notranslate"><span class="pre">parameters()</span></code> or <code class="docutils literal notranslate"><span class="pre">buffers()</span></code> can be used to
retrieve a container of all parameters in the entire (nested) module hierarchy.
Similarly, methods like <code class="docutils literal notranslate"><span class="pre">to(...)</span></code>, where e.g. <code class="docutils literal notranslate"><span class="pre">to(torch::kCUDA)</span></code> moves all
parameters and buffers from CPU to CUDA memory, work on the entire module
hierarchy.</p>
<div class="section" id="defining-a-module-and-registering-parameters">
<h4>Defining a Module and Registering Parameters<a class="headerlink" href="#defining-a-module-and-registering-parameters" title="Permalink to this headline">¶</a></h4>
<p>To put these words into code, let’s consider this simple module written in the
Python interface:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>

<span class="k">class</span> <span class="nc">Net</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">Net</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">M</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">addmm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>
</pre></div>
</div>
<p>In C++, it would look like this:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;torch/torch.h&gt;</span><span class="cp"></span>

<span class="k">struct</span> <span class="nl">Net</span> <span class="p">:</span> <span class="n">torch</span><span class="o">::</span><span class="n">nn</span><span class="o">::</span><span class="n">Module</span> <span class="p">{</span>
  <span class="n">Net</span><span class="p">(</span><span class="kt">int64_t</span> <span class="n">N</span><span class="p">,</span> <span class="kt">int64_t</span> <span class="n">M</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">register_parameter</span><span class="p">(</span><span class="s">"W"</span><span class="p">,</span> <span class="n">torch</span><span class="o">::</span><span class="n">randn</span><span class="p">({</span><span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="p">}));</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">register_parameter</span><span class="p">(</span><span class="s">"b"</span><span class="p">,</span> <span class="n">torch</span><span class="o">::</span><span class="n">randn</span><span class="p">(</span><span class="n">M</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="n">torch</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">forward</span><span class="p">(</span><span class="n">torch</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">input</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">::</span><span class="n">addmm</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">input</span><span class="p">,</span> <span class="n">W</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">torch</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">W</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Just like in Python, we define a class called <code class="docutils literal notranslate"><span class="pre">Net</span></code> (for simplicity here a
<code class="docutils literal notranslate"><span class="pre">struct</span></code> instead of a <code class="docutils literal notranslate"><span class="pre">class</span></code>) and derive it from the module base class.
Inside the constructor, we create tensors using <code class="docutils literal notranslate"><span class="pre">torch::randn</span></code> just like we
use <code class="docutils literal notranslate"><span class="pre">torch.randn</span></code> in Python. One interesting difference is how we register the
parameters. In Python, we wrap the tensors with the <code class="docutils literal notranslate"><span class="pre">torch.nn.Parameter</span></code>
class, while in C++ we have to pass the tensor through the
<code class="docutils literal notranslate"><span class="pre">register_parameter</span></code> method instead. The reason for this is that the Python
API can detect that an attribute is of type <code class="docutils literal notranslate"><span class="pre">torch.nn.Parameter</span></code> and
automatically registers such tensors. In C++, reflection is very limited, so a
more traditional (and less magical) approach is provided.</p>
</div>
<div class="section" id="registering-submodules-and-traversing-the-module-hierarchy">
<h4>Registering Submodules and Traversing the Module Hierarchy<a class="headerlink" href="#registering-submodules-and-traversing-the-module-hierarchy" title="Permalink to this headline">¶</a></h4>
<p>In the same way we can register parameters, we can also register submodules. In
Python, submodules are automatically detected and registered when they are
assigned as an attribute of a module:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Net</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="p">):</span>
      <span class="nb">super</span><span class="p">(</span><span class="n">Net</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
      <span class="c1"># Registered as a submodule behind the scenes</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">linear</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">another_bias</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">M</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">another_bias</span>
</pre></div>
</div>
<p>This allows, for example, to use the <code class="docutils literal notranslate"><span class="pre">parameters()</span></code> method to recursively
access all parameters in our module hierarchy:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">net</span> <span class="o">=</span> <span class="n">Net</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">parameters</span><span class="p">()))</span>
<span class="go">[Parameter containing:</span>
<span class="go">tensor([0.0808, 0.8613, 0.2017, 0.5206, 0.5353], requires_grad=True), Parameter containing:</span>
<span class="go">tensor([[-0.3740, -0.0976, -0.4786, -0.4928],</span>
<span class="go">        [-0.1434,  0.4713,  0.1735, -0.3293],</span>
<span class="go">        [-0.3467, -0.3858,  0.1980,  0.1986],</span>
<span class="go">        [-0.1975,  0.4278, -0.1831, -0.2709],</span>
<span class="go">        [ 0.3730,  0.4307,  0.3236, -0.0629]], requires_grad=True), Parameter containing:</span>
<span class="go">tensor([ 0.2038,  0.4638, -0.2023,  0.1230, -0.0516], requires_grad=True)]</span>
</pre></div>
</div>
<p>To register submodules in C++, use the aptly named <code class="docutils literal notranslate"><span class="pre">register_module()</span></code> method
to register a module like <code class="docutils literal notranslate"><span class="pre">torch::nn::Linear</span></code>:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="nl">Net</span> <span class="p">:</span> <span class="n">torch</span><span class="o">::</span><span class="n">nn</span><span class="o">::</span><span class="n">Module</span> <span class="p">{</span>
  <span class="n">Net</span><span class="p">(</span><span class="kt">int64_t</span> <span class="n">N</span><span class="p">,</span> <span class="kt">int64_t</span> <span class="n">M</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">linear</span><span class="p">(</span><span class="n">register_module</span><span class="p">(</span><span class="s">"linear"</span><span class="p">,</span> <span class="n">torch</span><span class="o">::</span><span class="n">nn</span><span class="o">::</span><span class="n">Linear</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="p">)))</span> <span class="p">{</span>
    <span class="n">another_bias</span> <span class="o">=</span> <span class="n">register_parameter</span><span class="p">(</span><span class="s">"b"</span><span class="p">,</span> <span class="n">torch</span><span class="o">::</span><span class="n">randn</span><span class="p">(</span><span class="n">M</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="n">torch</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">forward</span><span class="p">(</span><span class="n">torch</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">input</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">linear</span><span class="p">(</span><span class="n">input</span><span class="p">)</span> <span class="o">+</span> <span class="n">another_bias</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">torch</span><span class="o">::</span><span class="n">nn</span><span class="o">::</span><span class="n">Linear</span> <span class="n">linear</span><span class="p">;</span>
  <span class="n">torch</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">another_bias</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">You can find the full list of available built-in modules like
<code class="docutils literal notranslate"><span class="pre">torch::nn::Linear</span></code>, <code class="docutils literal notranslate"><span class="pre">torch::nn::Dropout</span></code> or <code class="docutils literal notranslate"><span class="pre">torch::nn::Conv2d</span></code> in the
documentation of the <code class="docutils literal notranslate"><span class="pre">torch::nn</span></code> namespace <a class="reference external" href="https://pytorch.org/cppdocs/api/namespace_torch__nn.html">here</a>.</p>
</div>
<p>One subtlety about the above code is why the submodule was created in the
constructor’s initializer list, while the parameter was created inside the
constructor body. There is a good reason for this, which we’ll touch upon this
in the section on the C++ frontend’s <em>ownership model</em> further below. The end
result, however, is that we can recursively access our module tree’s parameters
just like in Python. Calling <code class="docutils literal notranslate"><span class="pre">parameters()</span></code> returns a
<code class="docutils literal notranslate"><span class="pre">std::vector&lt;torch::Tensor&gt;</span></code>, which we can iterate over:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">Net</span> <span class="n">net</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">p</span> <span class="p">:</span> <span class="n">net</span><span class="p">.</span><span class="n">parameters</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">p</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>which prints:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>root@fa350df05ecf:/home/build# ./dcgan
<span class="m">0</span>.0345
<span class="m">1</span>.4456
-0.6313
-0.3585
-0.4008
<span class="o">[</span> Variable<span class="o">[</span>CPUFloatType<span class="o">]{</span><span class="m">5</span><span class="o">}</span> <span class="o">]</span>
-0.1647  <span class="m">0</span>.2891  <span class="m">0</span>.0527 -0.0354
<span class="m">0</span>.3084  <span class="m">0</span>.2025  <span class="m">0</span>.0343  <span class="m">0</span>.1824
-0.4630 -0.2862  <span class="m">0</span>.2500 -0.0420
<span class="m">0</span>.3679 -0.1482 -0.0460  <span class="m">0</span>.1967
<span class="m">0</span>.2132 -0.1992  <span class="m">0</span>.4257  <span class="m">0</span>.0739
<span class="o">[</span> Variable<span class="o">[</span>CPUFloatType<span class="o">]{</span><span class="m">5</span>,4<span class="o">}</span> <span class="o">]</span>
<span class="m">0</span>.01 *
<span class="m">3</span>.6861
-10.1166
-45.0333
<span class="m">7</span>.9983
-20.0705
<span class="o">[</span> Variable<span class="o">[</span>CPUFloatType<span class="o">]{</span><span class="m">5</span><span class="o">}</span> <span class="o">]</span>
</pre></div>
</div>
<p>with three parameters just like in Python. To also see the names of these
parameters, the C++ API provides a <code class="docutils literal notranslate"><span class="pre">named_parameters()</span></code> method which returns
an <code class="docutils literal notranslate"><span class="pre">OrderedDict</span></code> just like in Python:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Net</span> <span class="nf">net</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
<span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">pair</span> <span class="p">:</span> <span class="n">net</span><span class="p">.</span><span class="n">named_parameters</span><span class="p">())</span> <span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">pair</span><span class="p">.</span><span class="n">key</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">": "</span> <span class="o">&lt;&lt;</span> <span class="n">pair</span><span class="p">.</span><span class="n">value</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>which we can execute again to see the output:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>root@fa350df05ecf:/home/build# make <span class="o">&amp;&amp;</span> ./dcgan                                                                                                                                            <span class="m">11</span>:13:48
Scanning dependencies of target dcgan
<span class="o">[</span> <span class="m">50</span>%<span class="o">]</span> Building CXX object CMakeFiles/dcgan.dir/dcgan.cpp.o
<span class="o">[</span><span class="m">100</span>%<span class="o">]</span> Linking CXX executable dcgan
<span class="o">[</span><span class="m">100</span>%<span class="o">]</span> Built target dcgan
b: -0.1863
-0.8611
-0.1228
<span class="m">1</span>.3269
<span class="m">0</span>.9858
<span class="o">[</span> Variable<span class="o">[</span>CPUFloatType<span class="o">]{</span><span class="m">5</span><span class="o">}</span> <span class="o">]</span>
linear.weight:  <span class="m">0</span>.0339  <span class="m">0</span>.2484  <span class="m">0</span>.2035 -0.2103
-0.0715 -0.2975 -0.4350 -0.1878
-0.3616  <span class="m">0</span>.1050 -0.4982  <span class="m">0</span>.0335
-0.1605  <span class="m">0</span>.4963  <span class="m">0</span>.4099 -0.2883
<span class="m">0</span>.1818 -0.3447 -0.1501 -0.0215
<span class="o">[</span> Variable<span class="o">[</span>CPUFloatType<span class="o">]{</span><span class="m">5</span>,4<span class="o">}</span> <span class="o">]</span>
linear.bias: -0.0250
<span class="m">0</span>.0408
<span class="m">0</span>.3756
-0.2149
-0.3636
<span class="o">[</span> Variable<span class="o">[</span>CPUFloatType<span class="o">]{</span><span class="m">5</span><span class="o">}</span> <span class="o">]</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><a class="reference external" href="https://pytorch.org/cppdocs/api/classtorch_1_1nn_1_1_module.html#exhale-class-classtorch-1-1nn-1-1-module">The documentation</a>
for <code class="docutils literal notranslate"><span class="pre">torch::nn::Module</span></code> contains the full list of methods that operate on
the module hierarchy.</p>
</div>
</div>
<div class="section" id="running-the-network-in-forward-mode">
<h4>Running the Network in Forward Mode<a class="headerlink" href="#running-the-network-in-forward-mode" title="Permalink to this headline">¶</a></h4>
<p>To execute the network in C++, we simply call the <code class="docutils literal notranslate"><span class="pre">forward()</span></code> method we
defined ourselves:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">Net</span> <span class="n">net</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">net</span><span class="p">.</span><span class="n">forward</span><span class="p">(</span><span class="n">torch</span><span class="o">::</span><span class="n">ones</span><span class="p">({</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">}))</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>which prints something like:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>root@fa350df05ecf:/home/build# ./dcgan
<span class="m">0</span>.8559  <span class="m">1</span>.1572  <span class="m">2</span>.1069 -0.1247  <span class="m">0</span>.8060
<span class="m">0</span>.8559  <span class="m">1</span>.1572  <span class="m">2</span>.1069 -0.1247  <span class="m">0</span>.8060
<span class="o">[</span> Variable<span class="o">[</span>CPUFloatType<span class="o">]{</span><span class="m">2</span>,5<span class="o">}</span> <span class="o">]</span>
</pre></div>
</div>
</div>
<div class="section" id="module-ownership">
<h4>Module Ownership<a class="headerlink" href="#module-ownership" title="Permalink to this headline">¶</a></h4>
<p>At this point, we know how to define a module in C++, register parameters,
register submodules, traverse the module hierarchy via methods like
<code class="docutils literal notranslate"><span class="pre">parameters()</span></code> and finally run the module’s <code class="docutils literal notranslate"><span class="pre">forward()</span></code> method. While there
are many more methods, classes and topics to devour in the C++ API, I will refer
you to <a class="reference external" href="https://pytorch.org/cppdocs/api/namespace_torch__nn.html">docs</a> for
the full menu. We’ll also touch upon some more concepts as we implement the
DCGAN model and end-to-end training pipeline in just a second. Before we do so,
let me briefly touch upon the <em>ownership model</em> the C++ frontend provides for
subclasses of <code class="docutils literal notranslate"><span class="pre">torch::nn::Module</span></code>.</p>
<p>For this discussion, the ownership model refers to the way modules are stored
and passed around – which determines who or what <em>owns</em> a particular module
instance. In Python, objects are always allocated dynamically (on the heap) and
have reference semantics. This is very easy to work with and straightforward to
understand. In fact, in Python, you can largely forget about where objects live
and how they get referenced, and focus on getting things done.</p>
<p>C++, being a lower level language, provides more options in this realm. This
increases complexity and heavily influences the design and ergonomics of the C++
frontend. In particular, for modules in the C++ frontend, we have the option of
using <em>either</em> value semantics <em>or</em> reference semantics. The first case is the
simplest and was shown in the examples thus far: module objects are allocated on
the stack and when passed to a function, can be either copied, moved (with
<code class="docutils literal notranslate"><span class="pre">std::move</span></code>) or taken by reference or by pointer:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="nl">Net</span> <span class="p">:</span> <span class="n">torch</span><span class="o">::</span><span class="n">nn</span><span class="o">::</span><span class="n">Module</span> <span class="p">{</span> <span class="p">};</span>

<span class="kt">void</span> <span class="nf">a</span><span class="p">(</span><span class="n">Net</span> <span class="n">net</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="kt">void</span> <span class="nf">b</span><span class="p">(</span><span class="n">Net</span><span class="o">&amp;</span> <span class="n">net</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="kt">void</span> <span class="nf">c</span><span class="p">(</span><span class="n">Net</span><span class="o">*</span> <span class="n">net</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">Net</span> <span class="n">net</span><span class="p">;</span>
  <span class="n">a</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
  <span class="n">a</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">net</span><span class="p">));</span>
  <span class="n">b</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
  <span class="n">c</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>For the second case – reference semantics – we can use <code class="docutils literal notranslate"><span class="pre">std::shared_ptr</span></code>.
The advantage of reference semantics is that, like in Python, it reduces the
cognitive overhead of thinking about how modules must be passed to functions and
how arguments must be declared (assuming you use <code class="docutils literal notranslate"><span class="pre">shared_ptr</span></code> everywhere).</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="nl">Net</span> <span class="p">:</span> <span class="n">torch</span><span class="o">::</span><span class="n">nn</span><span class="o">::</span><span class="n">Module</span> <span class="p">{};</span>

<span class="kt">void</span> <span class="nf">a</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Net</span><span class="o">&gt;</span> <span class="n">net</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">auto</span> <span class="n">net</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">Net</span><span class="o">&gt;</span><span class="p">();</span>
  <span class="n">a</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In our experience, researchers coming from dynamic languages greatly prefer
reference semantics over value semantics, even though the latter is more
“native” to C++. It is also important to note that <code class="docutils literal notranslate"><span class="pre">torch::nn::Module</span></code>’s
design, in order to stay close to the ergonomics of the Python API, relies on
shared ownership. For example, take our earlier (here shortened) definition of
<code class="docutils literal notranslate"><span class="pre">Net</span></code>:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="nl">Net</span> <span class="p">:</span> <span class="n">torch</span><span class="o">::</span><span class="n">nn</span><span class="o">::</span><span class="n">Module</span> <span class="p">{</span>
  <span class="n">Net</span><span class="p">(</span><span class="kt">int64_t</span> <span class="n">N</span><span class="p">,</span> <span class="kt">int64_t</span> <span class="n">M</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">linear</span><span class="p">(</span><span class="n">register_module</span><span class="p">(</span><span class="s">"linear"</span><span class="p">,</span> <span class="n">torch</span><span class="o">::</span><span class="n">nn</span><span class="o">::</span><span class="n">Linear</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="p">)))</span>
  <span class="p">{</span> <span class="p">}</span>
  <span class="n">torch</span><span class="o">::</span><span class="n">nn</span><span class="o">::</span><span class="n">Linear</span> <span class="n">linear</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>In order to use the <code class="docutils literal notranslate"><span class="pre">linear</span></code> submodule, we want to store it directly in our
class. However, we also want the module base class to know about and have access
to this submodule. For this, it must store a reference to this submodule. At
this point, we have already arrived at the need for shared ownership. Both the
<code class="docutils literal notranslate"><span class="pre">torch::nn::Module</span></code> class and concrete <code class="docutils literal notranslate"><span class="pre">Net</span></code> class require a reference to
the submodule. For this reason, the base class stores modules as
<code class="docutils literal notranslate"><span class="pre">shared_ptr</span></code>s, and therefore the concrete class must too.</p>
<p>But wait! I don’t see any mention of <code class="docutils literal notranslate"><span class="pre">shared_ptr</span></code> in the above code! Why is
that? Well, because <code class="docutils literal notranslate"><span class="pre">std::shared_ptr&lt;MyModule&gt;</span></code> is a hell of a lot to type. To
keep our researchers productive, we came up with an elaborate scheme to hide the
mention of <code class="docutils literal notranslate"><span class="pre">shared_ptr</span></code> – a benefit usually reserved for value semantics –
while retaining reference semantics. To understand how this works, we can take a
look at a simplified definition of the <code class="docutils literal notranslate"><span class="pre">torch::nn::Linear</span></code> module in the core
library (the full definition is <a class="reference external" href="https://github.com/pytorch/pytorch/blob/master/torch/csrc/api/include/torch/nn/modules/linear.h">here</a>):</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="nl">LinearImpl</span> <span class="p">:</span> <span class="n">torch</span><span class="o">::</span><span class="n">nn</span><span class="o">::</span><span class="n">Module</span> <span class="p">{</span>
  <span class="n">LinearImpl</span><span class="p">(</span><span class="kt">int64_t</span> <span class="n">in</span><span class="p">,</span> <span class="kt">int64_t</span> <span class="n">out</span><span class="p">);</span>

  <span class="n">Tensor</span> <span class="nf">forward</span><span class="p">(</span><span class="k">const</span> <span class="n">Tensor</span><span class="o">&amp;</span> <span class="n">input</span><span class="p">);</span>

  <span class="n">Tensor</span> <span class="n">weight</span><span class="p">,</span> <span class="n">bias</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">TORCH_MODULE</span><span class="p">(</span><span class="n">Linear</span><span class="p">);</span>
</pre></div>
</div>
<p>In brief: the module is not called <code class="docutils literal notranslate"><span class="pre">Linear</span></code>, but <code class="docutils literal notranslate"><span class="pre">LinearImpl</span></code>. A macro,
<code class="docutils literal notranslate"><span class="pre">TORCH_MODULE</span></code> then defines the actual <code class="docutils literal notranslate"><span class="pre">Linear</span></code> class. This “generated”
class is effectively a wrapper over a <code class="docutils literal notranslate"><span class="pre">std::shared_ptr&lt;LinearImpl&gt;</span></code>. It is a
wrapper instead of a simple typedef so that, among other things, constructors
still work as expected, i.e. you can still write <code class="docutils literal notranslate"><span class="pre">torch::nn::Linear(3,</span> <span class="pre">4)</span></code>
instead of <code class="docutils literal notranslate"><span class="pre">std::make_shared&lt;LinearImpl&gt;(3,</span> <span class="pre">4)</span></code>. We call the class created by
the macro the module <em>holder</em>. Like with (shared) pointers, you access the
underlying object using the arrow operator (like <code class="docutils literal notranslate"><span class="pre">model-&gt;forward(...)</span></code>). The
end result is an ownership model that resembles that of the Python API quite
closely. Reference semantics become the default, but without the extra typing of
<code class="docutils literal notranslate"><span class="pre">std::shared_ptr</span></code> or <code class="docutils literal notranslate"><span class="pre">std::make_shared</span></code>. For our <code class="docutils literal notranslate"><span class="pre">Net</span></code>, using the module
holder API looks like this:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="nl">NetImpl</span> <span class="p">:</span> <span class="n">torch</span><span class="o">::</span><span class="n">nn</span><span class="o">::</span><span class="n">Module</span> <span class="p">{};</span>
<span class="n">TORCH_MODULE</span><span class="p">(</span><span class="n">Net</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">a</span><span class="p">(</span><span class="n">Net</span> <span class="n">net</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">Net</span> <span class="n">net</span><span class="p">;</span>
  <span class="n">a</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>There is one subtle issue that deserves mention here. A default constructed
<code class="docutils literal notranslate"><span class="pre">std::shared_ptr</span></code> is “empty”, i.e. contains a null pointer. What is a default
constructed <code class="docutils literal notranslate"><span class="pre">Linear</span></code> or <code class="docutils literal notranslate"><span class="pre">Net</span></code>? Well, it’s a tricky choice. We could say it
should be an empty (null) <code class="docutils literal notranslate"><span class="pre">std::shared_ptr&lt;LinearImpl&gt;</span></code>. However, recall that
<code class="docutils literal notranslate"><span class="pre">Linear(3,</span> <span class="pre">4)</span></code> is the same as <code class="docutils literal notranslate"><span class="pre">std::make_shared&lt;LinearImpl&gt;(3,</span> <span class="pre">4)</span></code>. This
means that if we had decided that <code class="docutils literal notranslate"><span class="pre">Linear</span> <span class="pre">linear;</span></code> should be a null pointer,
then there would be no way to construct a module that does not take any
constructor arguments, or defaults all of them. For this reason, in the current
API, a default constructed module holder (like <code class="docutils literal notranslate"><span class="pre">Linear()</span></code>) invokes the
default constructor of the underlying module (<code class="docutils literal notranslate"><span class="pre">LinearImpl()</span></code>). If the
underlying module does not have a default constructor, you get a compiler error.
To instead construct the empty holder, you can pass <code class="docutils literal notranslate"><span class="pre">nullptr</span></code> to the
constructor of the holder.</p>
<p>In practice, this means you can use submodules either like shown earlier, where
the module is registered and constructed in the <em>initializer list</em>:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="nl">Net</span> <span class="p">:</span> <span class="n">torch</span><span class="o">::</span><span class="n">nn</span><span class="o">::</span><span class="n">Module</span> <span class="p">{</span>
  <span class="n">Net</span><span class="p">(</span><span class="kt">int64_t</span> <span class="n">N</span><span class="p">,</span> <span class="kt">int64_t</span> <span class="n">M</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">linear</span><span class="p">(</span><span class="n">register_module</span><span class="p">(</span><span class="s">"linear"</span><span class="p">,</span> <span class="n">torch</span><span class="o">::</span><span class="n">nn</span><span class="o">::</span><span class="n">Linear</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="p">)))</span>
  <span class="p">{</span> <span class="p">}</span>
  <span class="n">torch</span><span class="o">::</span><span class="n">nn</span><span class="o">::</span><span class="n">Linear</span> <span class="n">linear</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>or you can first construct the holder with a null pointer and then assign to it
in the constructor (more familiar for Pythonistas):</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="nl">Net</span> <span class="p">:</span> <span class="n">torch</span><span class="o">::</span><span class="n">nn</span><span class="o">::</span><span class="n">Module</span> <span class="p">{</span>
  <span class="n">Net</span><span class="p">(</span><span class="kt">int64_t</span> <span class="n">N</span><span class="p">,</span> <span class="kt">int64_t</span> <span class="n">M</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">linear</span> <span class="o">=</span> <span class="n">register_module</span><span class="p">(</span><span class="s">"linear"</span><span class="p">,</span> <span class="n">torch</span><span class="o">::</span><span class="n">nn</span><span class="o">::</span><span class="n">Linear</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="n">torch</span><span class="o">::</span><span class="n">nn</span><span class="o">::</span><span class="n">Linear</span> <span class="n">linear</span><span class="p">{</span><span class="k">nullptr</span><span class="p">};</span> <span class="c1">// construct an empty holder</span>
<span class="p">};</span>
</pre></div>
</div>
<p>In conclusion: Which ownership model – which semantics – should you use? The
C++ frontend’s API best supports the ownership model provided by module holders.
The only disadvantage of this mechanism is one extra line of boilerplate below
the module declaration. That said, the simplest model is still the value
semantics model shown in the introduction to C++ modules. For small, simple
scripts, you may get away with it too. But you’ll find sooner or later that, for
technical reasons, it is not always supported. For example, the serialization
API (<code class="docutils literal notranslate"><span class="pre">torch::save</span></code> and <code class="docutils literal notranslate"><span class="pre">torch::load</span></code>) only supports module holders (or plain
<code class="docutils literal notranslate"><span class="pre">shared_ptr</span></code>). As such, the module holder API is the recommended way of
defining modules with the C++ frontend, and we will use this API in this
tutorial henceforth.</p>
</div>
</div>
<div class="section" id="defining-the-dcgan-modules">
<h3>Defining the DCGAN Modules<a class="headerlink" href="#defining-the-dcgan-modules" title="Permalink to this headline">¶</a></h3>
<p>We now have the necessary background and introduction to define the modules for
the machine learning task we want to solve in this post. To recap: our task is
to generate images of digits from the <a class="reference external" href="http://yann.lecun.com/exdb/mnist/">MNIST dataset</a>. We want to use a <a class="reference external" href="https://papers.nips.cc/paper/5423-generative-adversarial-nets.pdf">generative adversarial
network (GAN)</a> to solve
this task. In particular, we’ll use a <a class="reference external" href="https://arxiv.org/abs/1511.06434">DCGAN architecture</a> – one of the first and simplest of its
kind, but entirely sufficient for this task.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">You can find the full source code presented in this tutorial <a class="reference external" href="https://github.com/pytorch/examples/tree/master/cpp/dcgan">in this
repository</a>.</p>
</div>
<div class="section" id="what-was-a-gan-agan">
<h4>What was a GAN aGAN?<a class="headerlink" href="#what-was-a-gan-agan" title="Permalink to this headline">¶</a></h4>
<p>A GAN consists of two distinct neural network models: a <em>generator</em> and a
<em>discriminator</em>. The generator receives samples from a noise distribution, and
its aim is to transform each noise sample into an image that resembles those of
a target distribution – in our case the MNIST dataset. The discriminator in
turn receives either <em>real</em> images from the MNIST dataset, or <em>fake</em> images from
the generator. It is asked to emit a probability judging how real (closer to
<code class="docutils literal notranslate"><span class="pre">1</span></code>) or fake (closer to <code class="docutils literal notranslate"><span class="pre">0</span></code>) a particular image is. Feedback from the
discriminator on how real the images produced by the generator are is used to
train the generator. Feedback on how good of an eye for authenticity the
discriminator has is used to optimize the discriminator. In theory, a delicate
balance between the generator and discriminator makes them improve in tandem,
leading to the generator producing images indistinguishable from the target
distribution, fooling the discriminator’s (by then) excellent eye into emitting
a probability of <code class="docutils literal notranslate"><span class="pre">0.5</span></code> for both real and fake images. For us, the end result
is a machine that receives noise as input and generates realistic images of
digits as its output.</p>
</div>
<div class="section" id="the-generator-module">
<h4>The Generator Module<a class="headerlink" href="#the-generator-module" title="Permalink to this headline">¶</a></h4>
<p>We begin by defining the generator module, which consists of a series of
transposed 2D convolutions, batch normalizations and ReLU activation units. Like
in Python, PyTorch here provides two APIs for model definition: a functional one
where inputs are passed through successive functions, and a more object-oriented
one where we build a <code class="docutils literal notranslate"><span class="pre">Sequential</span></code> module containing the entire model as
submodules. Let’s see how our generator looks with either API, and you can
decide for yourself which one you prefer. First, using <code class="docutils literal notranslate"><span class="pre">Sequential</span></code>:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">using</span> <span class="k">namespace</span> <span class="n">torch</span><span class="p">;</span>

<span class="n">nn</span><span class="o">::</span><span class="n">Sequential</span> <span class="n">generator</span><span class="p">(</span>
    <span class="c1">// Layer 1</span>
    <span class="n">nn</span><span class="o">::</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">nn</span><span class="o">::</span><span class="n">Conv2dOptions</span><span class="p">(</span><span class="n">kNoiseSize</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
                   <span class="p">.</span><span class="n">with_bias</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span>
                   <span class="p">.</span><span class="n">transposed</span><span class="p">(</span><span class="nb">true</span><span class="p">)),</span>
    <span class="n">nn</span><span class="o">::</span><span class="n">BatchNorm</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
    <span class="n">nn</span><span class="o">::</span><span class="n">Functional</span><span class="p">(</span><span class="n">torch</span><span class="o">::</span><span class="n">relu</span><span class="p">),</span>
    <span class="c1">// Layer 2</span>
    <span class="n">nn</span><span class="o">::</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">nn</span><span class="o">::</span><span class="n">Conv2dOptions</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                   <span class="p">.</span><span class="n">stride</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                   <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                   <span class="p">.</span><span class="n">with_bias</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span>
                   <span class="p">.</span><span class="n">transposed</span><span class="p">(</span><span class="nb">true</span><span class="p">)),</span>
    <span class="n">nn</span><span class="o">::</span><span class="n">BatchNorm</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span>
    <span class="n">nn</span><span class="o">::</span><span class="n">Functional</span><span class="p">(</span><span class="n">torch</span><span class="o">::</span><span class="n">relu</span><span class="p">),</span>
    <span class="c1">// Layer 3</span>
    <span class="n">nn</span><span class="o">::</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">nn</span><span class="o">::</span><span class="n">Conv2dOptions</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
                   <span class="p">.</span><span class="n">stride</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                   <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                   <span class="p">.</span><span class="n">with_bias</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span>
                   <span class="p">.</span><span class="n">transposed</span><span class="p">(</span><span class="nb">true</span><span class="p">)),</span>
    <span class="n">nn</span><span class="o">::</span><span class="n">BatchNorm</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span>
    <span class="n">nn</span><span class="o">::</span><span class="n">Functional</span><span class="p">(</span><span class="n">torch</span><span class="o">::</span><span class="n">relu</span><span class="p">),</span>
    <span class="c1">// Layer 4</span>
    <span class="n">nn</span><span class="o">::</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">nn</span><span class="o">::</span><span class="n">Conv2dOptions</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
                   <span class="p">.</span><span class="n">stride</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                   <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                   <span class="p">.</span><span class="n">with_bias</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span>
                   <span class="p">.</span><span class="n">transposed</span><span class="p">(</span><span class="nb">true</span><span class="p">)),</span>
    <span class="n">nn</span><span class="o">::</span><span class="n">Functional</span><span class="p">(</span><span class="n">torch</span><span class="o">::</span><span class="n">tanh</span><span class="p">));</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">A <code class="docutils literal notranslate"><span class="pre">Sequential</span></code> module simply performs function composition. The output of
the first submodule becomes the input of the second, the output of the third
becomes the input of the fourth and so on.</p>
</div>
<p>The particular modules chosen, like <code class="docutils literal notranslate"><span class="pre">nn::Conv2d</span></code> and <code class="docutils literal notranslate"><span class="pre">nn::BatchNorm</span></code>,
follows the structure outlined earlier. The <code class="docutils literal notranslate"><span class="pre">kNoiseSize</span></code> constant determines
the size of the input noise vector and is set to <code class="docutils literal notranslate"><span class="pre">100</span></code>. Notice also that we
use the <code class="docutils literal notranslate"><span class="pre">torch::nn::Functional</span></code> module for our activation functions, passing
it <code class="docutils literal notranslate"><span class="pre">torch::relu</span></code> for inner layers and <code class="docutils literal notranslate"><span class="pre">torch::tanh</span></code> as the final activation.
Hyperparameters were, of course, found via grad student descent.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The Python frontend has one module for each activation function, like
<code class="docutils literal notranslate"><span class="pre">torch.nn.ReLU</span></code> or <code class="docutils literal notranslate"><span class="pre">torch.nn.Tanh</span></code>. In C++, we instead only provide the
<code class="docutils literal notranslate"><span class="pre">Functional</span></code> module, to which you can pass any C++ function that will be
called inside the <code class="docutils literal notranslate"><span class="pre">Functional</span></code>’s <code class="docutils literal notranslate"><span class="pre">forward()</span></code> method.</p>
</div>
<div class="admonition attention">
<p class="first admonition-title">Attention</p>
<p class="last">No grad students were harmed in the discovery of hyperparameters. They were
fed Soylent regularly.</p>
</div>
<p>For the second approach, we explicitly pass inputs (in a functional way) between
modules in the <code class="docutils literal notranslate"><span class="pre">forward()</span></code> method of a module we define ourselves:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="nl">GeneratorImpl</span> <span class="p">:</span> <span class="n">nn</span><span class="o">::</span><span class="n">Module</span> <span class="p">{</span>
  <span class="n">GeneratorImpl</span><span class="p">()</span>
      <span class="o">:</span> <span class="n">conv1</span><span class="p">(</span><span class="n">nn</span><span class="o">::</span><span class="n">Conv2dOptions</span><span class="p">(</span><span class="n">kNoiseSize</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
                  <span class="p">.</span><span class="n">with_bias</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span>
                  <span class="p">.</span><span class="n">transposed</span><span class="p">(</span><span class="nb">true</span><span class="p">)),</span>
        <span class="n">batch_norm1</span><span class="p">(</span><span class="mi">512</span><span class="p">),</span>
        <span class="n">conv2</span><span class="p">(</span><span class="n">nn</span><span class="o">::</span><span class="n">Conv2dOptions</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
                  <span class="p">.</span><span class="n">stride</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                  <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                  <span class="p">.</span><span class="n">with_bias</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span>
                  <span class="p">.</span><span class="n">transposed</span><span class="p">(</span><span class="nb">true</span><span class="p">)),</span>
        <span class="n">batch_norm2</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
        <span class="n">conv3</span><span class="p">(</span><span class="n">nn</span><span class="o">::</span><span class="n">Conv2dOptions</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
                  <span class="p">.</span><span class="n">stride</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                  <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                  <span class="p">.</span><span class="n">with_bias</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span>
                  <span class="p">.</span><span class="n">transposed</span><span class="p">(</span><span class="nb">true</span><span class="p">)),</span>
        <span class="n">batch_norm3</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span>
        <span class="n">conv4</span><span class="p">(</span><span class="n">nn</span><span class="o">::</span><span class="n">Conv2dOptions</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
                  <span class="p">.</span><span class="n">stride</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                  <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                  <span class="p">.</span><span class="n">with_bias</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span>
                  <span class="p">.</span><span class="n">transposed</span><span class="p">(</span><span class="nb">true</span><span class="p">)),</span>
        <span class="n">batch_norm4</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span>
        <span class="n">conv5</span><span class="p">(</span><span class="n">nn</span><span class="o">::</span><span class="n">Conv2dOptions</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
                  <span class="p">.</span><span class="n">stride</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                  <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                  <span class="p">.</span><span class="n">with_bias</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span>
                  <span class="p">.</span><span class="n">transposed</span><span class="p">(</span><span class="nb">true</span><span class="p">))</span> <span class="p">{}</span>

  <span class="n">torch</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">forward</span><span class="p">(</span><span class="n">torch</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">::</span><span class="n">relu</span><span class="p">(</span><span class="n">batch_norm1</span><span class="p">(</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)));</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">::</span><span class="n">relu</span><span class="p">(</span><span class="n">batch_norm2</span><span class="p">(</span><span class="n">conv2</span><span class="p">(</span><span class="n">x</span><span class="p">)));</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">::</span><span class="n">relu</span><span class="p">(</span><span class="n">batch_norm3</span><span class="p">(</span><span class="n">conv3</span><span class="p">(</span><span class="n">x</span><span class="p">)));</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">::</span><span class="n">relu</span><span class="p">(</span><span class="n">batch_norm4</span><span class="p">(</span><span class="n">conv4</span><span class="p">(</span><span class="n">x</span><span class="p">)));</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">::</span><span class="n">tanh</span><span class="p">(</span><span class="n">conv5</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">nn</span><span class="o">::</span><span class="n">Conv2d</span> <span class="n">conv1</span><span class="p">,</span> <span class="n">conv2</span><span class="p">,</span> <span class="n">conv3</span><span class="p">,</span> <span class="n">conv4</span><span class="p">,</span> <span class="n">conv5</span><span class="p">;</span>
  <span class="n">nn</span><span class="o">::</span><span class="n">BatchNorm</span> <span class="n">batch_norm1</span><span class="p">,</span> <span class="n">batch_norm2</span><span class="p">,</span> <span class="n">batch_norm3</span><span class="p">,</span> <span class="n">batch_norm4</span><span class="p">;</span>
<span class="p">};</span>
<span class="n">TORCH_MODULE</span><span class="p">(</span><span class="n">Generator</span><span class="p">);</span>

<span class="n">Generator</span> <span class="n">generator</span><span class="p">;</span>
</pre></div>
</div>
<p>Whichever approach we use, we can now invoke <code class="docutils literal notranslate"><span class="pre">forward()</span></code> on the <code class="docutils literal notranslate"><span class="pre">Generator</span></code> to
map a noise sample to an image.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">A brief word on the way options are passed to built-in modules like <code class="docutils literal notranslate"><span class="pre">Conv2d</span></code>
in the C++ frontend: Every module has some required options, like the number
of features for <code class="docutils literal notranslate"><span class="pre">BatchNorm</span></code>. If you only need to configure the required
options, you can pass them directly to the module’s constructor, like
<code class="docutils literal notranslate"><span class="pre">BatchNorm(128)</span></code> or <code class="docutils literal notranslate"><span class="pre">Dropout(0.5)</span></code> or <code class="docutils literal notranslate"><span class="pre">Conv2d(8,</span> <span class="pre">4,</span> <span class="pre">2)</span></code> (for input
channel count, output channel count, and kernel size). If, however, you need
to modify other options, which are normally defaulted, such as <code class="docutils literal notranslate"><span class="pre">with_bias</span></code>
for <code class="docutils literal notranslate"><span class="pre">Conv2d</span></code>, you need to construct and pass an <em>options</em> object. Every
module in the C++ frontend has an associated options struct, called
<code class="docutils literal notranslate"><span class="pre">ModuleOptions</span></code> where <code class="docutils literal notranslate"><span class="pre">Module</span></code> is the name of the module, like
<code class="docutils literal notranslate"><span class="pre">LinearOptions</span></code> for <code class="docutils literal notranslate"><span class="pre">Linear</span></code>. This is what we do for the <code class="docutils literal notranslate"><span class="pre">Conv2d</span></code>
modules above.</p>
</div>
</div>
<div class="section" id="the-discriminator-module">
<h4>The Discriminator Module<a class="headerlink" href="#the-discriminator-module" title="Permalink to this headline">¶</a></h4>
<p>The discriminator is similarly a sequence of convolutions, batch normalizations
and activations. However, the convolutions are now regular ones instead of
transposed, and we use a leaky ReLU with an alpha value of 0.2 instead of a
vanilla ReLU. Also, the final activation becomes a Sigmoid, which squashes
values into a range between 0 and 1. We can then interpret these squashed values
as the probabilities the discriminator assigns to images being real:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">nn</span><span class="o">::</span><span class="n">Sequential</span> <span class="n">discriminator</span><span class="p">(</span>
  <span class="c1">// Layer 1</span>
  <span class="n">nn</span><span class="o">::</span><span class="n">Conv2d</span><span class="p">(</span>
      <span class="n">nn</span><span class="o">::</span><span class="n">Conv2dOptions</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">4</span><span class="p">).</span><span class="n">stride</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="n">padding</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">with_bias</span><span class="p">(</span><span class="nb">false</span><span class="p">)),</span>
  <span class="n">nn</span><span class="o">::</span><span class="n">Functional</span><span class="p">(</span><span class="n">torch</span><span class="o">::</span><span class="n">leaky_relu</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span>
  <span class="c1">// Layer 2</span>
  <span class="n">nn</span><span class="o">::</span><span class="n">Conv2d</span><span class="p">(</span>
      <span class="n">nn</span><span class="o">::</span><span class="n">Conv2dOptions</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">4</span><span class="p">).</span><span class="n">stride</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="n">padding</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">with_bias</span><span class="p">(</span><span class="nb">false</span><span class="p">)),</span>
  <span class="n">nn</span><span class="o">::</span><span class="n">BatchNorm</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span>
  <span class="n">nn</span><span class="o">::</span><span class="n">Functional</span><span class="p">(</span><span class="n">torch</span><span class="o">::</span><span class="n">leaky_relu</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span>
  <span class="c1">// Layer 3</span>
  <span class="n">nn</span><span class="o">::</span><span class="n">Conv2d</span><span class="p">(</span>
      <span class="n">nn</span><span class="o">::</span><span class="n">Conv2dOptions</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">4</span><span class="p">).</span><span class="n">stride</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="n">padding</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">with_bias</span><span class="p">(</span><span class="nb">false</span><span class="p">)),</span>
  <span class="n">nn</span><span class="o">::</span><span class="n">BatchNorm</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
  <span class="n">nn</span><span class="o">::</span><span class="n">Functional</span><span class="p">(</span><span class="n">torch</span><span class="o">::</span><span class="n">leaky_relu</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span>
  <span class="c1">// Layer 4</span>
  <span class="n">nn</span><span class="o">::</span><span class="n">Conv2d</span><span class="p">(</span>
      <span class="n">nn</span><span class="o">::</span><span class="n">Conv2dOptions</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">).</span><span class="n">stride</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">padding</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">with_bias</span><span class="p">(</span><span class="nb">false</span><span class="p">)),</span>
  <span class="n">nn</span><span class="o">::</span><span class="n">Functional</span><span class="p">(</span><span class="n">torch</span><span class="o">::</span><span class="n">sigmoid</span><span class="p">));</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When the function we pass to <code class="docutils literal notranslate"><span class="pre">Functional</span></code> takes more arguments than a single
tensor, we can pass them to the <code class="docutils literal notranslate"><span class="pre">Functional</span></code> constructor, which will forward
them to each function call. For the leaky ReLU above, this means
<code class="docutils literal notranslate"><span class="pre">torch::leaky_relu(previous_output_tensor,</span> <span class="pre">0.2)</span></code> is called.</p>
</div>
</div>
</div>
</div>
<div class="section" id="loading-data">
<h2>Loading Data<a class="headerlink" href="#loading-data" title="Permalink to this headline">¶</a></h2>
<p>Now that we have defined the generator and discriminator model, we need some
data we can train these models with. The C++ frontend, like the Python one,
comes with a powerful parallel data loader. This data loader can read batches of
data from a dataset (which you can define yourself) and provides many
configuration knobs.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">While the Python data loader uses multi-processing, the C++ data loader is truly
multi-threaded and does not launch any new processes.</p>
</div>
<p>The data loader is part of the C++ frontend’s <code class="docutils literal notranslate"><span class="pre">data</span></code> api, contained in the
<code class="docutils literal notranslate"><span class="pre">torch::data::</span></code> namespace. This API consists of a few different components:</p>
<ul class="simple">
<li>The data loader class,</li>
<li>An API for defining datasets,</li>
<li>An API for defining <em>transforms</em>, which can be applied to datasets,</li>
<li>An API for defining <em>samplers</em>, which produce the indices with which datasets are indexed,</li>
<li>A library of existing datasets, transforms and samplers.</li>
</ul>
<p>For this tutorial, we can use the <code class="docutils literal notranslate"><span class="pre">MNIST</span></code> dataset that comes with the C++
frontend. Let’s instantiate a <code class="docutils literal notranslate"><span class="pre">torch::data::datasets::MNIST</span></code> for this, and
apply two transformations: First, we normalize the images so that they are in
the range of <code class="docutils literal notranslate"><span class="pre">-1</span></code> to <code class="docutils literal notranslate"><span class="pre">+1</span></code> (from an original range of <code class="docutils literal notranslate"><span class="pre">0</span></code> to <code class="docutils literal notranslate"><span class="pre">1</span></code>).
Second, we apply the <code class="docutils literal notranslate"><span class="pre">Stack</span></code> <em>collation</em>, which takes a batch of tensors and
stacks them into a single tensor along the first dimension:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">auto</span> <span class="n">dataset</span> <span class="o">=</span> <span class="n">torch</span><span class="o">::</span><span class="n">data</span><span class="o">::</span><span class="n">datasets</span><span class="o">::</span><span class="n">MNIST</span><span class="p">(</span><span class="s">"./mnist"</span><span class="p">)</span>
    <span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">torch</span><span class="o">::</span><span class="n">data</span><span class="o">::</span><span class="n">transforms</span><span class="o">::</span><span class="n">Normalize</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
    <span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">torch</span><span class="o">::</span><span class="n">data</span><span class="o">::</span><span class="n">transforms</span><span class="o">::</span><span class="n">Stack</span><span class="o">&lt;&gt;</span><span class="p">());</span>
</pre></div>
</div>
<p>Note that the MNIST dataset should be located in the <code class="docutils literal notranslate"><span class="pre">./mnist</span></code> directory
relative to wherever you execute the training binary from. You can use <a class="reference external" href="https://gist.github.com/goldsborough/6dd52a5e01ed73a642c1e772084bcd03">this
script</a>
to download the MNIST dataset.</p>
<p>Next, we create a data loader and pass it this dataset. To make a new data
loader, we use <code class="docutils literal notranslate"><span class="pre">torch::data::make_data_loader</span></code>, which returns a
<code class="docutils literal notranslate"><span class="pre">std::unique_ptr</span></code> of the correct type (which depends on the type of the
dataset, the type of the sampler and some other implementation details):</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">auto</span> <span class="n">data_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">::</span><span class="n">data</span><span class="o">::</span><span class="n">make_data_loader</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">dataset</span><span class="p">));</span>
</pre></div>
</div>
<p>The data loader does come with a lot of options. You can inspect the full set
<a class="reference external" href="https://github.com/pytorch/pytorch/blob/master/torch/csrc/api/include/torch/data/dataloader_options.h">here</a>.
For example, to speed up the data loading, we can increase the number of
workers. The default number is zero, which means the main thread will be used.
If we set <code class="docutils literal notranslate"><span class="pre">workers</span></code> to <code class="docutils literal notranslate"><span class="pre">2</span></code>, two threads will be spawned that load data
concurrently. We should also increase the batch size from its default of <code class="docutils literal notranslate"><span class="pre">1</span></code>
to something more reasonable, like <code class="docutils literal notranslate"><span class="pre">64</span></code> (the value of <code class="docutils literal notranslate"><span class="pre">kBatchSize</span></code>). So
let’s create a <code class="docutils literal notranslate"><span class="pre">DataLoaderOptions</span></code> object and set the appropriate properties:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">auto</span> <span class="n">data_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">::</span><span class="n">data</span><span class="o">::</span><span class="n">make_data_loader</span><span class="p">(</span>
    <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">dataset</span><span class="p">),</span>
    <span class="n">torch</span><span class="o">::</span><span class="n">data</span><span class="o">::</span><span class="n">DataLoaderOptions</span><span class="p">().</span><span class="n">batch_size</span><span class="p">(</span><span class="n">kBatchSize</span><span class="p">).</span><span class="n">workers</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
</pre></div>
</div>
<p>We can now write a loop to load batches of data, which we’ll only print to the
console for now:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="n">torch</span><span class="o">::</span><span class="n">data</span><span class="o">::</span><span class="n">Example</span><span class="o">&lt;&gt;&amp;</span> <span class="nl">batch</span> <span class="p">:</span> <span class="o">*</span><span class="n">data_loader</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Batch size: "</span> <span class="o">&lt;&lt;</span> <span class="n">batch</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">" | Labels: "</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int64_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">batch</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">batch</span><span class="p">.</span><span class="n">target</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">item</span><span class="o">&lt;</span><span class="kt">int64_t</span><span class="o">&gt;</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">" "</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The type returned by the data loader in this case is a <code class="docutils literal notranslate"><span class="pre">torch::data::Example</span></code>.
This type is a simple struct with a <code class="docutils literal notranslate"><span class="pre">data</span></code> field for the data and a <code class="docutils literal notranslate"><span class="pre">target</span></code>
field for the label. Because we applied the <code class="docutils literal notranslate"><span class="pre">Stack</span></code> collation earlier, the
data loader returns only a single such example. If we had not applied the
collation, the data loader would yield <code class="docutils literal notranslate"><span class="pre">std::vector&lt;torch::data::Example&lt;&gt;&gt;</span></code>
instead, with one element per example in the batch.</p>
<p>If you rebuild and run this code, you should see something like this:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>root@fa350df05ecf:/home/build# make
Scanning dependencies of target dcgan
<span class="o">[</span> <span class="m">50</span>%<span class="o">]</span> Building CXX object CMakeFiles/dcgan.dir/dcgan.cpp.o
<span class="o">[</span><span class="m">100</span>%<span class="o">]</span> Linking CXX executable dcgan
<span class="o">[</span><span class="m">100</span>%<span class="o">]</span> Built target dcgan
root@fa350df05ecf:/home/build# make
<span class="o">[</span><span class="m">100</span>%<span class="o">]</span> Built target dcgan
root@fa350df05ecf:/home/build# ./dcgan
Batch size: <span class="m">64</span> <span class="p">|</span> Labels: <span class="m">5</span> <span class="m">2</span> <span class="m">6</span> <span class="m">7</span> <span class="m">2</span> <span class="m">1</span> <span class="m">6</span> <span class="m">7</span> <span class="m">0</span> <span class="m">1</span> <span class="m">6</span> <span class="m">2</span> <span class="m">3</span> <span class="m">6</span> <span class="m">9</span> <span class="m">1</span> <span class="m">8</span> <span class="m">4</span> <span class="m">0</span> <span class="m">6</span> <span class="m">5</span> <span class="m">3</span> <span class="m">3</span> <span class="m">0</span> <span class="m">4</span> <span class="m">6</span> <span class="m">6</span> <span class="m">6</span> <span class="m">4</span> <span class="m">0</span> <span class="m">8</span> <span class="m">6</span> <span class="m">0</span> <span class="m">6</span> <span class="m">9</span> <span class="m">2</span> <span class="m">4</span> <span class="m">0</span> <span class="m">2</span> <span class="m">8</span> <span class="m">6</span> <span class="m">3</span> <span class="m">3</span> <span class="m">2</span> <span class="m">9</span> <span class="m">2</span> <span class="m">0</span> <span class="m">1</span> <span class="m">4</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">8</span> <span class="m">2</span> <span class="m">9</span> <span class="m">9</span> <span class="m">3</span> <span class="m">5</span> <span class="m">8</span> <span class="m">0</span> <span class="m">0</span> <span class="m">7</span> <span class="m">9</span> <span class="m">9</span>
Batch size: <span class="m">64</span> <span class="p">|</span> Labels: <span class="m">2</span> <span class="m">2</span> <span class="m">4</span> <span class="m">7</span> <span class="m">1</span> <span class="m">2</span> <span class="m">8</span> <span class="m">8</span> <span class="m">6</span> <span class="m">9</span> <span class="m">0</span> <span class="m">2</span> <span class="m">2</span> <span class="m">9</span> <span class="m">3</span> <span class="m">6</span> <span class="m">1</span> <span class="m">3</span> <span class="m">8</span> <span class="m">0</span> <span class="m">4</span> <span class="m">4</span> <span class="m">8</span> <span class="m">8</span> <span class="m">8</span> <span class="m">9</span> <span class="m">2</span> <span class="m">6</span> <span class="m">4</span> <span class="m">7</span> <span class="m">1</span> <span class="m">5</span> <span class="m">0</span> <span class="m">9</span> <span class="m">7</span> <span class="m">5</span> <span class="m">4</span> <span class="m">3</span> <span class="m">5</span> <span class="m">4</span> <span class="m">1</span> <span class="m">2</span> <span class="m">8</span> <span class="m">0</span> <span class="m">7</span> <span class="m">1</span> <span class="m">9</span> <span class="m">6</span> <span class="m">1</span> <span class="m">6</span> <span class="m">5</span> <span class="m">3</span> <span class="m">4</span> <span class="m">4</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">2</span> <span class="m">3</span> <span class="m">5</span> <span class="m">0</span> <span class="m">1</span> <span class="m">6</span> <span class="m">2</span>
Batch size: <span class="m">64</span> <span class="p">|</span> Labels: <span class="m">4</span> <span class="m">5</span> <span class="m">4</span> <span class="m">2</span> <span class="m">1</span> <span class="m">4</span> <span class="m">8</span> <span class="m">3</span> <span class="m">8</span> <span class="m">3</span> <span class="m">6</span> <span class="m">1</span> <span class="m">5</span> <span class="m">4</span> <span class="m">3</span> <span class="m">6</span> <span class="m">2</span> <span class="m">2</span> <span class="m">5</span> <span class="m">1</span> <span class="m">3</span> <span class="m">1</span> <span class="m">5</span> <span class="m">0</span> <span class="m">8</span> <span class="m">2</span> <span class="m">1</span> <span class="m">5</span> <span class="m">3</span> <span class="m">2</span> <span class="m">4</span> <span class="m">4</span> <span class="m">5</span> <span class="m">9</span> <span class="m">7</span> <span class="m">2</span> <span class="m">8</span> <span class="m">9</span> <span class="m">2</span> <span class="m">0</span> <span class="m">6</span> <span class="m">7</span> <span class="m">4</span> <span class="m">3</span> <span class="m">8</span> <span class="m">3</span> <span class="m">5</span> <span class="m">8</span> <span class="m">8</span> <span class="m">3</span> <span class="m">0</span> <span class="m">5</span> <span class="m">8</span> <span class="m">0</span> <span class="m">8</span> <span class="m">7</span> <span class="m">8</span> <span class="m">5</span> <span class="m">5</span> <span class="m">6</span> <span class="m">1</span> <span class="m">7</span> <span class="m">8</span> <span class="m">0</span>
Batch size: <span class="m">64</span> <span class="p">|</span> Labels: <span class="m">3</span> <span class="m">3</span> <span class="m">7</span> <span class="m">1</span> <span class="m">4</span> <span class="m">1</span> <span class="m">6</span> <span class="m">1</span> <span class="m">0</span> <span class="m">3</span> <span class="m">6</span> <span class="m">4</span> <span class="m">0</span> <span class="m">2</span> <span class="m">5</span> <span class="m">4</span> <span class="m">0</span> <span class="m">4</span> <span class="m">2</span> <span class="m">8</span> <span class="m">1</span> <span class="m">9</span> <span class="m">6</span> <span class="m">5</span> <span class="m">1</span> <span class="m">6</span> <span class="m">3</span> <span class="m">2</span> <span class="m">8</span> <span class="m">9</span> <span class="m">2</span> <span class="m">3</span> <span class="m">8</span> <span class="m">7</span> <span class="m">4</span> <span class="m">5</span> <span class="m">9</span> <span class="m">6</span> <span class="m">0</span> <span class="m">8</span> <span class="m">3</span> <span class="m">0</span> <span class="m">0</span> <span class="m">6</span> <span class="m">4</span> <span class="m">8</span> <span class="m">2</span> <span class="m">5</span> <span class="m">4</span> <span class="m">1</span> <span class="m">8</span> <span class="m">3</span> <span class="m">7</span> <span class="m">8</span> <span class="m">0</span> <span class="m">0</span> <span class="m">8</span> <span class="m">9</span> <span class="m">6</span> <span class="m">7</span> <span class="m">2</span> <span class="m">1</span> <span class="m">4</span> <span class="m">7</span>
Batch size: <span class="m">64</span> <span class="p">|</span> Labels: <span class="m">3</span> <span class="m">0</span> <span class="m">5</span> <span class="m">5</span> <span class="m">9</span> <span class="m">8</span> <span class="m">3</span> <span class="m">9</span> <span class="m">8</span> <span class="m">9</span> <span class="m">5</span> <span class="m">9</span> <span class="m">5</span> <span class="m">0</span> <span class="m">4</span> <span class="m">1</span> <span class="m">2</span> <span class="m">7</span> <span class="m">7</span> <span class="m">2</span> <span class="m">0</span> <span class="m">0</span> <span class="m">5</span> <span class="m">4</span> <span class="m">8</span> <span class="m">7</span> <span class="m">7</span> <span class="m">6</span> <span class="m">1</span> <span class="m">0</span> <span class="m">7</span> <span class="m">9</span> <span class="m">3</span> <span class="m">0</span> <span class="m">6</span> <span class="m">3</span> <span class="m">2</span> <span class="m">6</span> <span class="m">2</span> <span class="m">7</span> <span class="m">6</span> <span class="m">3</span> <span class="m">3</span> <span class="m">4</span> <span class="m">0</span> <span class="m">5</span> <span class="m">8</span> <span class="m">8</span> <span class="m">9</span> <span class="m">1</span> <span class="m">9</span> <span class="m">2</span> <span class="m">1</span> <span class="m">9</span> <span class="m">4</span> <span class="m">4</span> <span class="m">9</span> <span class="m">2</span> <span class="m">4</span> <span class="m">6</span> <span class="m">2</span> <span class="m">9</span> <span class="m">4</span> <span class="m">0</span>
Batch size: <span class="m">64</span> <span class="p">|</span> Labels: <span class="m">9</span> <span class="m">6</span> <span class="m">7</span> <span class="m">5</span> <span class="m">3</span> <span class="m">5</span> <span class="m">9</span> <span class="m">0</span> <span class="m">8</span> <span class="m">6</span> <span class="m">6</span> <span class="m">7</span> <span class="m">8</span> <span class="m">2</span> <span class="m">1</span> <span class="m">9</span> <span class="m">8</span> <span class="m">8</span> <span class="m">1</span> <span class="m">1</span> <span class="m">8</span> <span class="m">2</span> <span class="m">0</span> <span class="m">7</span> <span class="m">1</span> <span class="m">4</span> <span class="m">1</span> <span class="m">6</span> <span class="m">7</span> <span class="m">5</span> <span class="m">1</span> <span class="m">7</span> <span class="m">7</span> <span class="m">4</span> <span class="m">0</span> <span class="m">3</span> <span class="m">2</span> <span class="m">9</span> <span class="m">0</span> <span class="m">6</span> <span class="m">6</span> <span class="m">3</span> <span class="m">4</span> <span class="m">4</span> <span class="m">8</span> <span class="m">1</span> <span class="m">2</span> <span class="m">8</span> <span class="m">6</span> <span class="m">9</span> <span class="m">2</span> <span class="m">0</span> <span class="m">3</span> <span class="m">1</span> <span class="m">2</span> <span class="m">8</span> <span class="m">5</span> <span class="m">6</span> <span class="m">4</span> <span class="m">8</span> <span class="m">5</span> <span class="m">8</span> <span class="m">6</span> <span class="m">2</span>
Batch size: <span class="m">64</span> <span class="p">|</span> Labels: <span class="m">9</span> <span class="m">3</span> <span class="m">0</span> <span class="m">3</span> <span class="m">6</span> <span class="m">5</span> <span class="m">1</span> <span class="m">8</span> <span class="m">6</span> <span class="m">0</span> <span class="m">1</span> <span class="m">9</span> <span class="m">9</span> <span class="m">1</span> <span class="m">6</span> <span class="m">1</span> <span class="m">7</span> <span class="m">7</span> <span class="m">4</span> <span class="m">4</span> <span class="m">4</span> <span class="m">7</span> <span class="m">8</span> <span class="m">8</span> <span class="m">6</span> <span class="m">7</span> <span class="m">8</span> <span class="m">2</span> <span class="m">6</span> <span class="m">0</span> <span class="m">4</span> <span class="m">6</span> <span class="m">8</span> <span class="m">2</span> <span class="m">5</span> <span class="m">3</span> <span class="m">9</span> <span class="m">8</span> <span class="m">4</span> <span class="m">0</span> <span class="m">9</span> <span class="m">9</span> <span class="m">3</span> <span class="m">7</span> <span class="m">0</span> <span class="m">5</span> <span class="m">8</span> <span class="m">2</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span> <span class="m">2</span> <span class="m">8</span> <span class="m">2</span> <span class="m">5</span> <span class="m">3</span> <span class="m">7</span> <span class="m">1</span> <span class="m">9</span> <span class="m">1</span> <span class="m">8</span> <span class="m">2</span> <span class="m">2</span> <span class="m">7</span>
Batch size: <span class="m">64</span> <span class="p">|</span> Labels: <span class="m">9</span> <span class="m">1</span> <span class="m">9</span> <span class="m">2</span> <span class="m">7</span> <span class="m">2</span> <span class="m">6</span> <span class="m">0</span> <span class="m">8</span> <span class="m">6</span> <span class="m">8</span> <span class="m">7</span> <span class="m">7</span> <span class="m">4</span> <span class="m">8</span> <span class="m">6</span> <span class="m">1</span> <span class="m">1</span> <span class="m">6</span> <span class="m">8</span> <span class="m">5</span> <span class="m">7</span> <span class="m">9</span> <span class="m">1</span> <span class="m">3</span> <span class="m">2</span> <span class="m">0</span> <span class="m">5</span> <span class="m">1</span> <span class="m">7</span> <span class="m">3</span> <span class="m">1</span> <span class="m">6</span> <span class="m">1</span> <span class="m">0</span> <span class="m">8</span> <span class="m">6</span> <span class="m">0</span> <span class="m">8</span> <span class="m">1</span> <span class="m">0</span> <span class="m">5</span> <span class="m">4</span> <span class="m">9</span> <span class="m">3</span> <span class="m">8</span> <span class="m">5</span> <span class="m">8</span> <span class="m">4</span> <span class="m">8</span> <span class="m">0</span> <span class="m">1</span> <span class="m">2</span> <span class="m">6</span> <span class="m">2</span> <span class="m">4</span> <span class="m">2</span> <span class="m">7</span> <span class="m">7</span> <span class="m">3</span> <span class="m">7</span> <span class="m">4</span> <span class="m">5</span> <span class="m">3</span>
Batch size: <span class="m">64</span> <span class="p">|</span> Labels: <span class="m">8</span> <span class="m">8</span> <span class="m">3</span> <span class="m">1</span> <span class="m">8</span> <span class="m">6</span> <span class="m">4</span> <span class="m">2</span> <span class="m">9</span> <span class="m">5</span> <span class="m">8</span> <span class="m">0</span> <span class="m">2</span> <span class="m">8</span> <span class="m">6</span> <span class="m">6</span> <span class="m">7</span> <span class="m">0</span> <span class="m">9</span> <span class="m">8</span> <span class="m">3</span> <span class="m">8</span> <span class="m">7</span> <span class="m">1</span> <span class="m">6</span> <span class="m">6</span> <span class="m">2</span> <span class="m">7</span> <span class="m">7</span> <span class="m">4</span> <span class="m">5</span> <span class="m">5</span> <span class="m">2</span> <span class="m">1</span> <span class="m">7</span> <span class="m">9</span> <span class="m">5</span> <span class="m">4</span> <span class="m">9</span> <span class="m">1</span> <span class="m">0</span> <span class="m">3</span> <span class="m">1</span> <span class="m">9</span> <span class="m">3</span> <span class="m">9</span> <span class="m">8</span> <span class="m">8</span> <span class="m">5</span> <span class="m">3</span> <span class="m">7</span> <span class="m">5</span> <span class="m">3</span> <span class="m">6</span> <span class="m">8</span> <span class="m">9</span> <span class="m">4</span> <span class="m">2</span> <span class="m">0</span> <span class="m">1</span> <span class="m">2</span> <span class="m">5</span> <span class="m">4</span> <span class="m">7</span>
Batch size: <span class="m">64</span> <span class="p">|</span> Labels: <span class="m">9</span> <span class="m">2</span> <span class="m">7</span> <span class="m">0</span> <span class="m">8</span> <span class="m">4</span> <span class="m">4</span> <span class="m">2</span> <span class="m">7</span> <span class="m">5</span> <span class="m">0</span> <span class="m">0</span> <span class="m">6</span> <span class="m">2</span> <span class="m">0</span> <span class="m">5</span> <span class="m">9</span> <span class="m">5</span> <span class="m">9</span> <span class="m">8</span> <span class="m">8</span> <span class="m">9</span> <span class="m">3</span> <span class="m">5</span> <span class="m">7</span> <span class="m">5</span> <span class="m">4</span> <span class="m">7</span> <span class="m">3</span> <span class="m">0</span> <span class="m">5</span> <span class="m">7</span> <span class="m">6</span> <span class="m">5</span> <span class="m">7</span> <span class="m">1</span> <span class="m">6</span> <span class="m">2</span> <span class="m">8</span> <span class="m">7</span> <span class="m">6</span> <span class="m">3</span> <span class="m">2</span> <span class="m">6</span> <span class="m">5</span> <span class="m">6</span> <span class="m">1</span> <span class="m">2</span> <span class="m">7</span> <span class="m">7</span> <span class="m">0</span> <span class="m">0</span> <span class="m">5</span> <span class="m">9</span> <span class="m">0</span> <span class="m">0</span> <span class="m">9</span> <span class="m">1</span> <span class="m">7</span> <span class="m">8</span> <span class="m">3</span> <span class="m">2</span> <span class="m">9</span> <span class="m">4</span>
Batch size: <span class="m">64</span> <span class="p">|</span> Labels: <span class="m">7</span> <span class="m">6</span> <span class="m">5</span> <span class="m">7</span> <span class="m">7</span> <span class="m">5</span> <span class="m">2</span> <span class="m">2</span> <span class="m">4</span> <span class="m">9</span> <span class="m">9</span> <span class="m">4</span> <span class="m">8</span> <span class="m">7</span> <span class="m">4</span> <span class="m">8</span> <span class="m">9</span> <span class="m">4</span> <span class="m">5</span> <span class="m">7</span> <span class="m">1</span> <span class="m">2</span> <span class="m">6</span> <span class="m">9</span> <span class="m">8</span> <span class="m">5</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">6</span> <span class="m">7</span> <span class="m">8</span> <span class="m">1</span> <span class="m">1</span> <span class="m">3</span> <span class="m">9</span> <span class="m">8</span> <span class="m">7</span> <span class="m">9</span> <span class="m">5</span> <span class="m">0</span> <span class="m">8</span> <span class="m">5</span> <span class="m">1</span> <span class="m">8</span> <span class="m">7</span> <span class="m">2</span> <span class="m">6</span> <span class="m">5</span> <span class="m">1</span> <span class="m">2</span> <span class="m">0</span> <span class="m">9</span> <span class="m">7</span> <span class="m">4</span> <span class="m">0</span> <span class="m">9</span> <span class="m">0</span> <span class="m">4</span> <span class="m">6</span> <span class="m">0</span> <span class="m">0</span> <span class="m">8</span> <span class="m">6</span>
...
</pre></div>
</div>
<p>Which means we are successfully able to load data from the MNIST dataset.</p>
</div>
<div class="section" id="writing-the-training-loop">
<h2>Writing the Training Loop<a class="headerlink" href="#writing-the-training-loop" title="Permalink to this headline">¶</a></h2>
<p>Let’s now finish the algorithmic part of our example and implement the delicate
dance between the generator and discriminator. First, we’ll create two
optimizers, one for the generator and one for the discriminator. The optimizers
we use implement the <a class="reference external" href="https://arxiv.org/pdf/1412.6980.pdf">Adam</a> algorithm:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">torch</span><span class="o">::</span><span class="n">optim</span><span class="o">::</span><span class="n">Adam</span> <span class="n">generator_optimizer</span><span class="p">(</span>
    <span class="n">generator</span><span class="o">-&gt;</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">torch</span><span class="o">::</span><span class="n">optim</span><span class="o">::</span><span class="n">AdamOptions</span><span class="p">(</span><span class="mf">2e-4</span><span class="p">).</span><span class="n">beta1</span><span class="p">(</span><span class="mf">0.5</span><span class="p">));</span>
<span class="n">torch</span><span class="o">::</span><span class="n">optim</span><span class="o">::</span><span class="n">Adam</span> <span class="n">discriminator_optimizer</span><span class="p">(</span>
    <span class="n">discriminator</span><span class="o">-&gt;</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">torch</span><span class="o">::</span><span class="n">optim</span><span class="o">::</span><span class="n">AdamOptions</span><span class="p">(</span><span class="mf">5e-4</span><span class="p">).</span><span class="n">beta1</span><span class="p">(</span><span class="mf">0.5</span><span class="p">));</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">As of this writing, the C++ frontend provides optimizers implementing Adagrad,
Adam, LBFGS, RMSprop and SGD. The <a class="reference external" href="https://pytorch.org/cppdocs/api/namespace_torch__optim.html">docs</a> have the
up-to-date list.</p>
</div>
<p>Next, we need to update our training loop. We’ll add an outer loop to exhaust
the data loader every epoch and then write the GAN training code:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="kt">int64_t</span> <span class="n">epoch</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">epoch</span> <span class="o">&lt;=</span> <span class="n">kNumberOfEpochs</span><span class="p">;</span> <span class="o">++</span><span class="n">epoch</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int64_t</span> <span class="n">batch_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">torch</span><span class="o">::</span><span class="n">data</span><span class="o">::</span><span class="n">Example</span><span class="o">&lt;&gt;&amp;</span> <span class="nl">batch</span> <span class="p">:</span> <span class="o">*</span><span class="n">data_loader</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Train discriminator with real images.</span>
    <span class="n">discriminator</span><span class="o">-&gt;</span><span class="n">zero_grad</span><span class="p">();</span>
    <span class="n">torch</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">real_images</span> <span class="o">=</span> <span class="n">batch</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
    <span class="n">torch</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">real_labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">::</span><span class="n">empty</span><span class="p">(</span><span class="n">batch</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)).</span><span class="n">uniform_</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
    <span class="n">torch</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">real_output</span> <span class="o">=</span> <span class="n">discriminator</span><span class="o">-&gt;</span><span class="n">forward</span><span class="p">(</span><span class="n">real_images</span><span class="p">);</span>
    <span class="n">torch</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">d_loss_real</span> <span class="o">=</span> <span class="n">torch</span><span class="o">::</span><span class="n">binary_cross_entropy</span><span class="p">(</span><span class="n">real_output</span><span class="p">,</span> <span class="n">real_labels</span><span class="p">);</span>
    <span class="n">d_loss_real</span><span class="p">.</span><span class="n">backward</span><span class="p">();</span>

    <span class="c1">// Train discriminator with fake images.</span>
    <span class="n">torch</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">noise</span> <span class="o">=</span> <span class="n">torch</span><span class="o">::</span><span class="n">randn</span><span class="p">({</span><span class="n">batch</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">kNoiseSize</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">});</span>
    <span class="n">torch</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">fake_images</span> <span class="o">=</span> <span class="n">generator</span><span class="o">-&gt;</span><span class="n">forward</span><span class="p">(</span><span class="n">noise</span><span class="p">);</span>
    <span class="n">torch</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">fake_labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">::</span><span class="n">zeros</span><span class="p">(</span><span class="n">batch</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
    <span class="n">torch</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">fake_output</span> <span class="o">=</span> <span class="n">discriminator</span><span class="o">-&gt;</span><span class="n">forward</span><span class="p">(</span><span class="n">fake_images</span><span class="p">.</span><span class="n">detach</span><span class="p">());</span>
    <span class="n">torch</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">d_loss_fake</span> <span class="o">=</span> <span class="n">torch</span><span class="o">::</span><span class="n">binary_cross_entropy</span><span class="p">(</span><span class="n">fake_output</span><span class="p">,</span> <span class="n">fake_labels</span><span class="p">);</span>
    <span class="n">d_loss_fake</span><span class="p">.</span><span class="n">backward</span><span class="p">();</span>

    <span class="n">torch</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">d_loss</span> <span class="o">=</span> <span class="n">d_loss_real</span> <span class="o">+</span> <span class="n">d_loss_fake</span><span class="p">;</span>
    <span class="n">discriminator_optimizer</span><span class="p">.</span><span class="n">step</span><span class="p">();</span>

    <span class="c1">// Train generator.</span>
    <span class="n">generator</span><span class="o">-&gt;</span><span class="n">zero_grad</span><span class="p">();</span>
    <span class="n">fake_labels</span><span class="p">.</span><span class="n">fill_</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">fake_output</span> <span class="o">=</span> <span class="n">discriminator</span><span class="o">-&gt;</span><span class="n">forward</span><span class="p">(</span><span class="n">fake_images</span><span class="p">);</span>
    <span class="n">torch</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">g_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">::</span><span class="n">binary_cross_entropy</span><span class="p">(</span><span class="n">fake_output</span><span class="p">,</span> <span class="n">fake_labels</span><span class="p">);</span>
    <span class="n">g_loss</span><span class="p">.</span><span class="n">backward</span><span class="p">();</span>
    <span class="n">generator_optimizer</span><span class="p">.</span><span class="n">step</span><span class="p">();</span>

    <span class="n">std</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span>
        <span class="s">"</span><span class="se">\r</span><span class="s">[%2ld/%2ld][%3ld/%3ld] D_loss: %.4f | G_loss: %.4f"</span><span class="p">,</span>
        <span class="n">epoch</span><span class="p">,</span>
        <span class="n">kNumberOfEpochs</span><span class="p">,</span>
        <span class="o">++</span><span class="n">batch_index</span><span class="p">,</span>
        <span class="n">batches_per_epoch</span><span class="p">,</span>
        <span class="n">d_loss</span><span class="p">.</span><span class="n">item</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(),</span>
        <span class="n">g_loss</span><span class="p">.</span><span class="n">item</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">());</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Above, we first evaluate the discriminator on real images, for which it should
assign a high probability. For this, we use
<code class="docutils literal notranslate"><span class="pre">torch::empty(batch.data.size(0)).uniform_(0.8,</span> <span class="pre">1.0)</span></code> as the target
probabilities.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">We pick random values uniformly distributed between 0.8 and 1.0 instead of 1.0
everywhere in order to make the discriminator training more robust. This trick
is called <em>label smoothing</em>.</p>
</div>
<p>Before evaluating the discriminator, we zero out the gradients of its
parameters. After computing the loss, we back-propagate through the network by
calling <code class="docutils literal notranslate"><span class="pre">d_loss.backward()</span></code> to compute new gradients. We repeat this spiel for
the fake images. Instead of using images from the dataset, we let the generator
create fake images for this by feeding it a batch of random noise. We then
forward those fake images to the discriminator. This time, we want the
discriminator to emit low probabilities, ideally all zeros. Once we have
computed the discriminator loss for both the batch of real and the batch of fake
images, we can progress the discriminator’s optimizer by one step in order to
update its parameters.</p>
<p>To train the generator, we again first zero its gradients, and then re-evaluate
the discriminator on the fake images. However, this time we want the
discriminator to assign probabilities very close to one, which would indicate
that the generator can produce images that fool the discriminator into thinking
they are actually real (from the dataset). For this, we fill the <code class="docutils literal notranslate"><span class="pre">fake_labels</span></code>
tensor with all ones. We finally step the generator’s optimizer to also update
its parameters.</p>
<p>We should now be ready to train our model on the CPU. We don’t have any code yet
to capture state or sample outputs, but we’ll add this in just a moment. For
now, let’s just observe that our model is doing <em>something</em> – we’ll later
verify based on the generated images whether this something is meaningful.
Re-building and running should print something like:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>root@3c0711f20896:/home/build# make <span class="o">&amp;&amp;</span> ./dcgan
Scanning dependencies of target dcgan
<span class="o">[</span> <span class="m">50</span>%<span class="o">]</span> Building CXX object CMakeFiles/dcgan.dir/dcgan.cpp.o
<span class="o">[</span><span class="m">100</span>%<span class="o">]</span> Linking CXX executable dcgan
<span class="o">[</span><span class="m">100</span>%<span class="o">]</span> Built target dcga
<span class="o">[</span> <span class="m">1</span>/10<span class="o">][</span><span class="m">100</span>/938<span class="o">]</span> D_loss: <span class="m">0</span>.6876 <span class="p">|</span> G_loss: <span class="m">4</span>.1304
<span class="o">[</span> <span class="m">1</span>/10<span class="o">][</span><span class="m">200</span>/938<span class="o">]</span> D_loss: <span class="m">0</span>.3776 <span class="p">|</span> G_loss: <span class="m">4</span>.3101
<span class="o">[</span> <span class="m">1</span>/10<span class="o">][</span><span class="m">300</span>/938<span class="o">]</span> D_loss: <span class="m">0</span>.3652 <span class="p">|</span> G_loss: <span class="m">4</span>.6626
<span class="o">[</span> <span class="m">1</span>/10<span class="o">][</span><span class="m">400</span>/938<span class="o">]</span> D_loss: <span class="m">0</span>.8057 <span class="p">|</span> G_loss: <span class="m">2</span>.2795
<span class="o">[</span> <span class="m">1</span>/10<span class="o">][</span><span class="m">500</span>/938<span class="o">]</span> D_loss: <span class="m">0</span>.3531 <span class="p">|</span> G_loss: <span class="m">4</span>.4452
<span class="o">[</span> <span class="m">1</span>/10<span class="o">][</span><span class="m">600</span>/938<span class="o">]</span> D_loss: <span class="m">0</span>.3501 <span class="p">|</span> G_loss: <span class="m">5</span>.0811
<span class="o">[</span> <span class="m">1</span>/10<span class="o">][</span><span class="m">700</span>/938<span class="o">]</span> D_loss: <span class="m">0</span>.3581 <span class="p">|</span> G_loss: <span class="m">4</span>.5623
<span class="o">[</span> <span class="m">1</span>/10<span class="o">][</span><span class="m">800</span>/938<span class="o">]</span> D_loss: <span class="m">0</span>.6423 <span class="p">|</span> G_loss: <span class="m">1</span>.7385
<span class="o">[</span> <span class="m">1</span>/10<span class="o">][</span><span class="m">900</span>/938<span class="o">]</span> D_loss: <span class="m">0</span>.3592 <span class="p">|</span> G_loss: <span class="m">4</span>.7333
<span class="o">[</span> <span class="m">2</span>/10<span class="o">][</span><span class="m">100</span>/938<span class="o">]</span> D_loss: <span class="m">0</span>.4660 <span class="p">|</span> G_loss: <span class="m">2</span>.5242
<span class="o">[</span> <span class="m">2</span>/10<span class="o">][</span><span class="m">200</span>/938<span class="o">]</span> D_loss: <span class="m">0</span>.6364 <span class="p">|</span> G_loss: <span class="m">2</span>.0886
<span class="o">[</span> <span class="m">2</span>/10<span class="o">][</span><span class="m">300</span>/938<span class="o">]</span> D_loss: <span class="m">0</span>.3717 <span class="p">|</span> G_loss: <span class="m">3</span>.8103
<span class="o">[</span> <span class="m">2</span>/10<span class="o">][</span><span class="m">400</span>/938<span class="o">]</span> D_loss: <span class="m">1</span>.0201 <span class="p">|</span> G_loss: <span class="m">1</span>.3544
<span class="o">[</span> <span class="m">2</span>/10<span class="o">][</span><span class="m">500</span>/938<span class="o">]</span> D_loss: <span class="m">0</span>.4522 <span class="p">|</span> G_loss: <span class="m">2</span>.6545
...
</pre></div>
</div>
</div>
<div class="section" id="moving-to-the-gpu">
<h2>Moving to the GPU<a class="headerlink" href="#moving-to-the-gpu" title="Permalink to this headline">¶</a></h2>
<p>While our current script can run just fine on the CPU, we all know convolutions
are a lot faster on GPU. Let’s quickly discuss how we can move our training onto
the GPU. We’ll need to do two things for this: pass a GPU device specification
to tensors we allocate ourselves, and explicitly copy any other tensors onto the
GPU via the <code class="docutils literal notranslate"><span class="pre">to()</span></code> method all tensors and modules in the C++ frontend have.
The simplest way to achieve both is to create an instance of <code class="docutils literal notranslate"><span class="pre">torch::Device</span></code>
at the top level of our training script, and then pass that device to tensor
factory functions like <code class="docutils literal notranslate"><span class="pre">torch::zeros</span></code> as well as the <code class="docutils literal notranslate"><span class="pre">to()</span></code> method. We can
start by doing this with a CPU device:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Place this somewhere at the top of your training script.</span>
<span class="n">torch</span><span class="o">::</span><span class="n">Device</span> <span class="n">device</span><span class="p">(</span><span class="n">torch</span><span class="o">::</span><span class="n">kCPU</span><span class="p">);</span>
</pre></div>
</div>
<p>New tensor allocations like</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">torch</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">fake_labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">::</span><span class="n">zeros</span><span class="p">(</span><span class="n">batch</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</pre></div>
</div>
<p>should be updated to take the <code class="docutils literal notranslate"><span class="pre">device</span></code> as the last argument:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">torch</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">fake_labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">::</span><span class="n">zeros</span><span class="p">(</span><span class="n">batch</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">device</span><span class="p">);</span>
</pre></div>
</div>
<p>For tensors whose creation is not in our hands, like those coming from the MNIST
dataset, we must insert explicit <code class="docutils literal notranslate"><span class="pre">to()</span></code> calls. This means</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">torch</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">real_images</span> <span class="o">=</span> <span class="n">batch</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
</pre></div>
</div>
<p>becomes</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">torch</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">real_images</span> <span class="o">=</span> <span class="n">batch</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
</pre></div>
</div>
<p>and also our model parameters should be moved to the correct device:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">generator</span><span class="o">-&gt;</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
<span class="n">discriminator</span><span class="o">-&gt;</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If a tensor already lives on the device supplied to <code class="docutils literal notranslate"><span class="pre">to()</span></code>, the call is a
no-op. No extra copy is made.</p>
</div>
<p>At this point, we’ve just made our previous CPU-residing code more explicit.
However, it is now also very easy to change the device to a CUDA device:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">torch</span><span class="o">::</span><span class="n">Device</span> <span class="n">device</span><span class="p">(</span><span class="n">torch</span><span class="o">::</span><span class="n">kCUDA</span><span class="p">)</span>
</pre></div>
</div>
<p>And now all tensors will live on the GPU, calling into fast CUDA kernels for all
operations, without us having to change any downstream code. If we wanted to
specify a particular device index, it could be passed as the second argument to
the <code class="docutils literal notranslate"><span class="pre">Device</span></code> constructor. If we wanted different tensors to live on different
devices, we could pass separate device instances (for example one on CUDA device
0 and the other on CUDA device 1). We can even do this configuration
dynamically, which is often useful to make our training scripts more portable:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">torch</span><span class="o">::</span><span class="n">Device</span> <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">::</span><span class="n">kCPU</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">torch</span><span class="o">::</span><span class="n">cuda</span><span class="o">::</span><span class="n">is_available</span><span class="p">())</span> <span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"CUDA is available! Training on GPU."</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">::</span><span class="n">kCUDA</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>or even</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">torch</span><span class="o">::</span><span class="n">Device</span> <span class="n">device</span><span class="p">(</span><span class="n">torch</span><span class="o">::</span><span class="n">cuda</span><span class="o">::</span><span class="n">is_available</span><span class="p">()</span> <span class="o">?</span> <span class="n">torch</span><span class="o">::</span><span class="nl">kCUDA</span> <span class="p">:</span> <span class="n">torch</span><span class="o">::</span><span class="n">kCPU</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="checkpointing-and-recovering-the-training-state">
<h2>Checkpointing and Recovering the Training State<a class="headerlink" href="#checkpointing-and-recovering-the-training-state" title="Permalink to this headline">¶</a></h2>
<p>The last augmentation we should make to our training script is to periodically
save the state of our model parameters, the state of our optimizers as well as a
few generated image samples. If our computer were to crash in the middle of the
training procedure, the first two will allow us to restore the training state.
For long-lasting training sessions, this is absolutely essential. Fortunately,
the C++ frontend provides an API to serialize and deserialize both model and
optimizer state, as well as individual tensors.</p>
<p>The core API for this is <code class="docutils literal notranslate"><span class="pre">torch::save(thing,filename)</span></code> and
<code class="docutils literal notranslate"><span class="pre">torch::load(thing,filename)</span></code>, where <code class="docutils literal notranslate"><span class="pre">thing</span></code> could be a
<code class="docutils literal notranslate"><span class="pre">torch::nn::Module</span></code> subclass or an optimizer instance like the <code class="docutils literal notranslate"><span class="pre">Adam</span></code> object
we have in our training script. Let’s update our training loop to checkpoint the
model and optimizer state at a certain interval:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">batch_index</span> <span class="o">%</span> <span class="n">kCheckpointEvery</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Checkpoint the model and optimizer state.</span>
  <span class="n">torch</span><span class="o">::</span><span class="n">save</span><span class="p">(</span><span class="n">generator</span><span class="p">,</span> <span class="s">"generator-checkpoint.pt"</span><span class="p">);</span>
  <span class="n">torch</span><span class="o">::</span><span class="n">save</span><span class="p">(</span><span class="n">generator_optimizer</span><span class="p">,</span> <span class="s">"generator-optimizer-checkpoint.pt"</span><span class="p">);</span>
  <span class="n">torch</span><span class="o">::</span><span class="n">save</span><span class="p">(</span><span class="n">discriminator</span><span class="p">,</span> <span class="s">"discriminator-checkpoint.pt"</span><span class="p">);</span>
  <span class="n">torch</span><span class="o">::</span><span class="n">save</span><span class="p">(</span><span class="n">discriminator_optimizer</span><span class="p">,</span> <span class="s">"discriminator-optimizer-checkpoint.pt"</span><span class="p">);</span>
  <span class="c1">// Sample the generator and save the images.</span>
  <span class="n">torch</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">samples</span> <span class="o">=</span> <span class="n">generator</span><span class="o">-&gt;</span><span class="n">forward</span><span class="p">(</span><span class="n">torch</span><span class="o">::</span><span class="n">randn</span><span class="p">({</span><span class="mi">8</span><span class="p">,</span> <span class="n">kNoiseSize</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="n">device</span><span class="p">));</span>
  <span class="n">torch</span><span class="o">::</span><span class="n">save</span><span class="p">((</span><span class="n">samples</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">torch</span><span class="o">::</span><span class="n">str</span><span class="p">(</span><span class="s">"dcgan-sample-"</span><span class="p">,</span> <span class="n">checkpoint_counter</span><span class="p">,</span> <span class="s">".pt"</span><span class="p">));</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\n</span><span class="s">-&gt; checkpoint "</span> <span class="o">&lt;&lt;</span> <span class="o">++</span><span class="n">checkpoint_counter</span> <span class="o">&lt;&lt;</span> <span class="sc">'\n'</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">kCheckpointEvery</span></code> is an integer set to something like <code class="docutils literal notranslate"><span class="pre">100</span></code> to
checkpoint every <code class="docutils literal notranslate"><span class="pre">100</span></code> batches, and <code class="docutils literal notranslate"><span class="pre">checkpoint_counter</span></code> is a counter bumped
every time we make a checkpoint.</p>
<p>To restore the training state, you can add lines like these after all models and
optimizers are created, but before the training loop:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">torch</span><span class="o">::</span><span class="n">optim</span><span class="o">::</span><span class="n">Adam</span> <span class="n">generator_optimizer</span><span class="p">(</span>
    <span class="n">generator</span><span class="o">-&gt;</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">torch</span><span class="o">::</span><span class="n">optim</span><span class="o">::</span><span class="n">AdamOptions</span><span class="p">(</span><span class="mf">2e-4</span><span class="p">).</span><span class="n">beta1</span><span class="p">(</span><span class="mf">0.5</span><span class="p">));</span>
<span class="n">torch</span><span class="o">::</span><span class="n">optim</span><span class="o">::</span><span class="n">Adam</span> <span class="n">discriminator_optimizer</span><span class="p">(</span>
    <span class="n">discriminator</span><span class="o">-&gt;</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">torch</span><span class="o">::</span><span class="n">optim</span><span class="o">::</span><span class="n">AdamOptions</span><span class="p">(</span><span class="mf">2e-4</span><span class="p">).</span><span class="n">beta1</span><span class="p">(</span><span class="mf">0.5</span><span class="p">));</span>

<span class="k">if</span> <span class="p">(</span><span class="n">kRestoreFromCheckpoint</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">torch</span><span class="o">::</span><span class="n">load</span><span class="p">(</span><span class="n">generator</span><span class="p">,</span> <span class="s">"generator-checkpoint.pt"</span><span class="p">);</span>
  <span class="n">torch</span><span class="o">::</span><span class="n">load</span><span class="p">(</span><span class="n">generator_optimizer</span><span class="p">,</span> <span class="s">"generator-optimizer-checkpoint.pt"</span><span class="p">);</span>
  <span class="n">torch</span><span class="o">::</span><span class="n">load</span><span class="p">(</span><span class="n">discriminator</span><span class="p">,</span> <span class="s">"discriminator-checkpoint.pt"</span><span class="p">);</span>
  <span class="n">torch</span><span class="o">::</span><span class="n">load</span><span class="p">(</span>
      <span class="n">discriminator_optimizer</span><span class="p">,</span> <span class="s">"discriminator-optimizer-checkpoint.pt"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int64_t</span> <span class="n">checkpoint_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int64_t</span> <span class="n">epoch</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">epoch</span> <span class="o">&lt;=</span> <span class="n">kNumberOfEpochs</span><span class="p">;</span> <span class="o">++</span><span class="n">epoch</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int64_t</span> <span class="n">batch_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">torch</span><span class="o">::</span><span class="n">data</span><span class="o">::</span><span class="n">Example</span><span class="o">&lt;&gt;&amp;</span> <span class="nl">batch</span> <span class="p">:</span> <span class="o">*</span><span class="n">data_loader</span><span class="p">)</span> <span class="p">{</span>
</pre></div>
</div>
</div>
<div class="section" id="inspecting-generated-images">
<h2>Inspecting Generated Images<a class="headerlink" href="#inspecting-generated-images" title="Permalink to this headline">¶</a></h2>
<p>Our training script is now complete. We are ready to train our GAN, whether on
CPU or GPU. To inspect the intermediary output of our training procedure, for
which we added code to periodically save image samples to the
<code class="docutils literal notranslate"><span class="pre">"dcgan-sample-xxx.pt"</span></code> file, we can write a tiny Python script to load the
tensors and display them with matplotlib:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">argparse</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">torch</span>


<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"-i"</span><span class="p">,</span> <span class="s2">"--sample-file"</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"-o"</span><span class="p">,</span> <span class="s2">"--out-file"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">"out.png"</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"-d"</span><span class="p">,</span> <span class="s2">"--dimension"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">options</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

<span class="n">module</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">sample_file</span><span class="p">)</span>
<span class="n">images</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">dimension</span> <span class="o">*</span> <span class="n">options</span><span class="o">.</span><span class="n">dimension</span><span class="p">):</span>
  <span class="n">image</span> <span class="o">=</span> <span class="n">images</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
  <span class="n">array</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
  <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">dimension</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">dimension</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">index</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">)</span>
  <span class="n">axis</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
  <span class="n">axis</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">out_file</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"Saved "</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">out_file</span><span class="p">)</span>
</pre></div>
</div>
<p>Let’s now train our model for around 30 epochs:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>root@3c0711f20896:/home/build# make <span class="o">&amp;&amp;</span> ./dcgan                                                                                                                                <span class="m">10</span>:17:57
Scanning dependencies of target dcgan
<span class="o">[</span> <span class="m">50</span>%<span class="o">]</span> Building CXX object CMakeFiles/dcgan.dir/dcgan.cpp.o
<span class="o">[</span><span class="m">100</span>%<span class="o">]</span> Linking CXX executable dcgan
<span class="o">[</span><span class="m">100</span>%<span class="o">]</span> Built target dcgan
CUDA is available! Training on GPU.
<span class="o">[</span> <span class="m">1</span>/30<span class="o">][</span><span class="m">200</span>/938<span class="o">]</span> D_loss: <span class="m">0</span>.4953 <span class="p">|</span> G_loss: <span class="m">4</span>.0195
-&gt; checkpoint <span class="m">1</span>
<span class="o">[</span> <span class="m">1</span>/30<span class="o">][</span><span class="m">400</span>/938<span class="o">]</span> D_loss: <span class="m">0</span>.3610 <span class="p">|</span> G_loss: <span class="m">4</span>.8148
-&gt; checkpoint <span class="m">2</span>
<span class="o">[</span> <span class="m">1</span>/30<span class="o">][</span><span class="m">600</span>/938<span class="o">]</span> D_loss: <span class="m">0</span>.4072 <span class="p">|</span> G_loss: <span class="m">4</span>.36760
-&gt; checkpoint <span class="m">3</span>
<span class="o">[</span> <span class="m">1</span>/30<span class="o">][</span><span class="m">800</span>/938<span class="o">]</span> D_loss: <span class="m">0</span>.4444 <span class="p">|</span> G_loss: <span class="m">4</span>.0250
-&gt; checkpoint <span class="m">4</span>
<span class="o">[</span> <span class="m">2</span>/30<span class="o">][</span><span class="m">200</span>/938<span class="o">]</span> D_loss: <span class="m">0</span>.3761 <span class="p">|</span> G_loss: <span class="m">3</span>.8790
-&gt; checkpoint <span class="m">5</span>
<span class="o">[</span> <span class="m">2</span>/30<span class="o">][</span><span class="m">400</span>/938<span class="o">]</span> D_loss: <span class="m">0</span>.3977 <span class="p">|</span> G_loss: <span class="m">3</span>.3315
...
-&gt; checkpoint <span class="m">120</span>
<span class="o">[</span><span class="m">30</span>/30<span class="o">][</span><span class="m">938</span>/938<span class="o">]</span> D_loss: <span class="m">0</span>.3610 <span class="p">|</span> G_loss: <span class="m">3</span>.8084
</pre></div>
</div>
<p>And display the imags in a plot:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>root@3c0711f20896:/home/build# python display.py -i dcgan-sample-100.pt
Saved out.png
</pre></div>
</div>
<p>Which should look something like this:</p>
<div class="figure">
<img alt="digits" src="../_images/digits.png">
</img></div>
<p>Digits! Hooray! Now the ball is in your court: can you improve the model to make
the digits look even better?</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h2>
<p>This tutorial has hopefully given you a digestible digest of the PyTorch C++
frontend. A machine learning library like PyTorch by necessity has a very broad
and extensive API. As such, there are many concepts we did not have time or
space to discuss here. However, I encourage you to try out the API, and consult
<a class="reference external" href="https://pytorch.org/cppdocs/">our documentation</a> and in particular the
<a class="reference external" href="https://pytorch.org/cppdocs/api/library_root.html">Library API</a> section when
you get stuck. Also, remember that you can expect the C++ frontend to follow the
design and semantics of the Python frontend whenever we could make this
possible, so you can leverage this fact to increase your learning rate.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">You can find the full source code presented in this tutorial <a class="reference external" href="https://github.com/pytorch/examples/tree/master/cpp/dcgan">in this
repository</a>.</p>
</div>
<p>As always, if you run into any problems or have questions, you can use our
<a class="reference external" href="https://discuss.pytorch.org/">forum</a> or <a class="reference external" href="https://github.com/pytorch/pytorch/issues">GitHub issues</a> to get in touch.</p>
</div>
</div>
</article>
</div>
<footer>
<div aria-label="footer navigation" class="rst-footer-buttons" role="navigation">
<a accesskey="p" class="btn btn-neutral" href="cpp_export.html" rel="prev" title="Loading a PyTorch Model in C++"><img class="previous-page" src="../_static/images/chevron-right-orange.svg"/> Previous</a>
</div>
<hr/>
<div role="contentinfo">
<p>
        © Copyright 2017, PyTorch.

    </p>
</div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
</div>
</div>
<div class="pytorch-content-right" id="pytorch-content-right">
<div class="pytorch-right-menu" id="pytorch-right-menu">
<div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
<ul>
<li><a class="reference internal" href="#">Using the PyTorch C++ Frontend</a><ul>
<li><a class="reference internal" href="#motivation">Motivation</a></li>
<li><a class="reference internal" href="#writing-a-basic-application">Writing a Basic Application</a></li>
<li><a class="reference internal" href="#defining-the-neural-network-models">Defining the Neural Network Models</a><ul>
<li><a class="reference internal" href="#module-api-basics">Module API Basics</a><ul>
<li><a class="reference internal" href="#defining-a-module-and-registering-parameters">Defining a Module and Registering Parameters</a></li>
<li><a class="reference internal" href="#registering-submodules-and-traversing-the-module-hierarchy">Registering Submodules and Traversing the Module Hierarchy</a></li>
<li><a class="reference internal" href="#running-the-network-in-forward-mode">Running the Network in Forward Mode</a></li>
<li><a class="reference internal" href="#module-ownership">Module Ownership</a></li>
</ul>
</li>
<li><a class="reference internal" href="#defining-the-dcgan-modules">Defining the DCGAN Modules</a><ul>
<li><a class="reference internal" href="#what-was-a-gan-agan">What was a GAN aGAN?</a></li>
<li><a class="reference internal" href="#the-generator-module">The Generator Module</a></li>
<li><a class="reference internal" href="#the-discriminator-module">The Discriminator Module</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#loading-data">Loading Data</a></li>
<li><a class="reference internal" href="#writing-the-training-loop">Writing the Training Loop</a></li>
<li><a class="reference internal" href="#moving-to-the-gpu">Moving to the GPU</a></li>
<li><a class="reference internal" href="#checkpointing-and-recovering-the-training-state">Checkpointing and Recovering the Training State</a></li>
<li><a class="reference internal" href="#inspecting-generated-images">Inspecting Generated Images</a></li>
<li><a class="reference internal" href="#conclusion">Conclusion</a></li>
</ul>
</li>
</ul>
</div>
</div>
</div>
</section>
</div>
<script type="text/javascript">
           var DOCUMENTATION_OPTIONS = {
               URL_ROOT:'../',
               VERSION:'1.1.0',
               LANGUAGE:'None',
               COLLAPSE_INDEX:false,
               FILE_SUFFIX:'.html',
               HAS_SOURCE:  true,
               SOURCELINK_SUFFIX: '.txt'
           };
       </script>
<script src="../_static/jquery.js" type="text/javascript"></script>
<script src="../_static/underscore.js" type="text/javascript"></script>
<script src="../_static/doctools.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
<script src="../_static/js/vendor/popper.min.js" type="text/javascript"></script>
<script src="../_static/js/vendor/bootstrap.min.js" type="text/javascript"></script>
<script src="../_static/js/theme.js" type="text/javascript"></script>
<script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-90545585-2', 'auto');
  ga('send', 'pageview');

</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-117752657-2"></script>
<script>

  window.dataLayer = window.dataLayer || [];

  function gtag(){dataLayer.push(arguments);}

  gtag('js', new Date());
  gtag('config', 'UA-117752657-2');

</script>
<script>
  !function(f,b,e,v,n,t,s)
  {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};
  if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
  n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];
  s.parentNode.insertBefore(t,s)}(window,document,'script',
  'https://connect.facebook.net/en_US/fbevents.js');
  fbq('init', '243028289693773');
  fbq('track', 'PageView');

  $("[data-behavior='call-to-action-event']").on('click', function(){
    fbq('trackCustom', "Download", {
      tutorialTitle: $('h1:first').text(),
      downloadLink: this.href,
      tutorialLink: window.location.href,
      downloadTitle: $(this).attr("data-response")
    });
    ga('send', {
      hitType: 'event',
      eventCategory: 'Download',
      eventAction: 'click',
      eventLabel: $(this).attr("data-response")
    });
   });

   $("[data-behavior='was-this-helpful-event']").on('click', function(){
    $(".helpful-question").hide();
    $(".was-helpful-thank-you").show();
    fbq('trackCustom', "Was this Helpful?", {
      tutorialLink: window.location.href,
      tutorialTitle: $('h1:first').text(),
      helpful: $(this).attr("data-response")
    });
    ga('send', {
      hitType: 'event',
      eventCategory: 'Was this Helpful?',
      eventAction: 'click',
      eventLabel: $(this).attr("data-response")
    });
   });

   if (location.pathname == "/") {
     $(".helpful-container").hide();
     $(".hr-bottom").hide();
   }
</script>
<noscript>
<img height="1" src="https://www.facebook.com/tr?id=243028289693773&amp;ev=PageView
  &amp;noscript=1" width="1">
</img></noscript>
<img alt="" height="1" src="https://www.googleadservices.com/pagead/conversion/795629140/?label=txkmCPmdtosBENSssfsC&amp;guid=ON&amp;script=0" style="border-style:none;" width="1"/>
<!-- Begin Footer -->
<div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
<div class="container">
<div class="row">
<div class="col-md-4 text-center">
<h2>Docs</h2>
<p>Access comprehensive developer documentation for PyTorch</p>
<a class="with-right-arrow" href="https://pytorch.org/docs/stable/index.html">View Docs</a>
</div>
<div class="col-md-4 text-center">
<h2>Tutorials</h2>
<p>Get in-depth tutorials for beginners and advanced developers</p>
<a class="with-right-arrow" href="https://pytorch.org/tutorials">View Tutorials</a>
</div>
<div class="col-md-4 text-center">
<h2>Resources</h2>
<p>Find development resources and get your questions answered</p>
<a class="with-right-arrow" href="https://pytorch.org/resources">View Resources</a>
</div>
</div>
</div>
</div>
<footer class="site-footer">
<div class="container footer-container">
<div class="footer-logo-wrapper">
<a class="footer-logo" href="https://pytorch.org/"></a>
</div>
<div class="footer-links-wrapper">
<div class="footer-links-col">
<ul>
<li class="list-title"><a href="https://pytorch.org/">PyTorch</a></li>
<li><a href="https://pytorch.org/get-started">Get Started</a></li>
<li><a href="https://pytorch.org/features">Features</a></li>
<li><a href="https://pytorch.org/ecosystem">Ecosystem</a></li>
<li><a href="https://pytorch.org/blog/">Blog</a></li>
<li><a href="https://pytorch.org/resources">Resources</a></li>
</ul>
</div>
<div class="footer-links-col">
<ul>
<li class="list-title"><a href="https://pytorch.org/support">Support</a></li>
<li><a href="https://pytorch.org/tutorials">Tutorials</a></li>
<li><a href="https://pytorch.org/docs/stable/index.html">Docs</a></li>
<li><a href="https://discuss.pytorch.org" target="_blank">Discuss</a></li>
<li><a href="https://github.com/pytorch/pytorch/issues" target="_blank">Github Issues</a></li>
<li><a href="https://pytorch.slack.com" target="_blank">Slack</a></li>
<li><a href="https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md" target="_blank">Contributing</a></li>
</ul>
</div>
<div class="footer-links-col follow-us-col">
<ul>
<li class="list-title">Follow Us</li>
<li>
<div id="mc_embed_signup">
<form action="https://twitter.us14.list-manage.com/subscribe/post?u=75419c71fe0a935e53dfa4a3f&amp;id=91d0dccd39" class="email-subscribe-form validate" id="mc-embedded-subscribe-form" method="post" name="mc-embedded-subscribe-form" novalidate="" target="_blank">
<div class="email-subscribe-form-fields-wrapper" id="mc_embed_signup_scroll">
<div class="mc-field-group">
<label for="mce-EMAIL" style="display:none;">Email Address</label>
<input class="required email" id="mce-EMAIL" name="EMAIL" placeholder="Email Address" type="email" value=""/>
</div>
<div class="clear" id="mce-responses">
<div class="response" id="mce-error-response" style="display:none"></div>
<div class="response" id="mce-success-response" style="display:none"></div>
</div> <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
<div aria-hidden="true" style="position: absolute; left: -5000px;"><input name="b_75419c71fe0a935e53dfa4a3f_91d0dccd39" tabindex="-1" type="text" value=""/></div>
<div class="clear">
<input class="button email-subscribe-button" id="mc-embedded-subscribe" name="subscribe" type="submit" value=""/>
</div>
</div>
</form>
</div>
</li>
</ul>
<div class="footer-social-icons">
<a class="facebook" href="https://www.facebook.com/pytorch" target="_blank"></a>
<a class="twitter" href="https://twitter.com/pytorch" target="_blank"></a>
</div>
</div>
</div>
</div>
</footer>
<!-- End Footer -->
<!-- Begin Mobile Menu -->
<div class="mobile-main-menu">
<div class="container-fluid">
<div class="container">
<div class="mobile-main-menu-header-container">
<a aria-label="PyTorch" class="header-logo" href="https://pytorch.org/"></a>
<a class="main-menu-close-button" data-behavior="close-mobile-menu" href="#"></a>
</div>
</div>
</div>
<div class="mobile-main-menu-links-container">
<div class="main-menu">
<ul>
<li>
<a href="#">Get Started</a>
</li>
<li>
<a href="#">Features</a>
</li>
<li>
<a href="#">Ecosystem</a>
</li>
<li>
<a href="https://pytorch.org/blog/">Blog</a>
</li>
<li class="active">
<a href="https://pytorch.org/tutorials">Tutorials</a>
</li>
<li>
<a href="https://pytorch.org/docs/stable/index.html">Docs</a>
</li>
<li>
<a href="https://pytorch.org/resources">Resources</a>
</li>
<li>
<a href="https://github.com/pytorch/pytorch">Github</a>
</li>
</ul>
</div>
</div>
</div>
<!-- End Mobile Menu -->
<script src="../_static/js/vendor/anchor.min.js" type="text/javascript"></script>
<script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>